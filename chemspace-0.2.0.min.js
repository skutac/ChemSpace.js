var ChemSpace;!function e(t,i,n){function r(a,s){if(!i[a]){if(!t[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var c=i[a]={exports:{}};t[a][0].call(c.exports,function(e){var i=t[a][1][e];return r(i||e)},c,c.exports,e,t,i,n)}return i[a].exports}for(var o="function"==typeof require&&require,a=0;a<n.length;a++)r(n[a]);return r}({1:[function(e){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}var i=Math.min,n=Math.max,r=t(e("./src/Drawer")),o=t(e("./src/Parser"));window.SmilesDrawer={Version:"1.0.0"},window.SmilesDrawer.Drawer=r.default,window.SmilesDrawer.Parser=o.default,window.SmilesDrawer.clean=function(e){return e.replace(/[^A-Za-z0-9@\.\+\-\?!\(\)\[\]\{\}/\\=#\$:\*]/g,"")},window.SmilesDrawer.apply=function(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"canvas[data-smiles]",i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"light",n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,o=new r.default(e),a=document.querySelectorAll(t),s=function(){var e=a[l];SmilesDrawer.parse(e.getAttribute("data-smiles"),function(t){o.draw(t,e,i,!1)},function(e){n&&n(e)})},l=0;l<a.length;l++)s()},window.SmilesDrawer.parse=function(e,t,i){try{t&&t(o.default.parse(e))}catch(e){i&&i(e)}},Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(e){if(null==this)throw new TypeError("this is null or not defined");for(var t=Object(this),r=t.length>>>0,o=arguments[1]>>0,a=0>o?n(r+o,0):i(o,r),s=arguments[2],l=void 0===s?r:s>>0,h=0>l?n(r+l,0):i(l,r);a<h;)t[a]=e,a++;return t}})},{"./src/Drawer":5,"./src/Parser":10}],2:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"clone",value:function(t){var i=Array.isArray(t)?[]:{};for(var r in t){var o=t[r];i[r]="function"==typeof o.clone?o.clone():"object"===(void 0===o?"undefined":n(o))?e.clone(o):o}return i}},{key:"equals",value:function(e,t){if(e.length!==t.length)return!1;for(var i=e.slice().sort(),n=t.slice().sort(),r=0;r<i.length;r++)if(i[r]!==n[r])return!1;return!0}},{key:"print",value:function(e){if(0==e.length)return"";for(var t="(",i=0;i<e.length;i++)t+=e[i].id?e[i].id+", ":e[i]+", ";return(t=t.substring(0,t.length-2))+")"}},{key:"each",value:function(e,t){for(var i=0;i<e.length;i++)t(e[i])}},{key:"get",value:function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]==i)return e[n]}},{key:"contains",value:function(e,t){if(t.property||t.func){if(t.func){for(var i=0;i<e.length;i++)if(t.func(e[i]))return!0}else for(var n=0;n<e.length;n++)if(e[n][t.property]==t.value)return!0}else for(var r=0;r<e.length;r++)if(e[r]==t.value)return!0;return!1}},{key:"intersection",value:function(e,t){for(var i=[],n=0;n<e.length;n++)for(var r=0;r<t.length;r++)e[n]===t[r]&&i.push(e[n]);return i}},{key:"unique",value:function(e){var t={};return e.filter(function(e){return void 0===t[e]&&(t[e]=!0)})}},{key:"count",value:function(e,t){for(var i=0,n=0;n<e.length;n++)e[n]===t&&i++;return i}},{key:"toggle",value:function(e,t){for(var i=[],n=!1,r=0;r<e.length;r++)e[r]===t?n=!0:i.push(e[r]);return n||i.push(t),i}},{key:"remove",value:function(e,t){for(var i=[],n=0;n<e.length;n++)e[n]!==t&&i.push(e[n]);return i}},{key:"removeUnique",value:function(e,t){var i=e.indexOf(t);return-1<i&&e.splice(i,1),e}},{key:"removeAll",value:function(e,t){return e.filter(function(e){return-1===t.indexOf(e)})}},{key:"merge",value:function(e,t){for(var i=Array(e.length+t.length),n=0;n<e.length;n++)i[n]=e[n];for(var r=0;r<t.length;r++)i[e.length+r]=t[r];return i}},{key:"containsAll",value:function(e,t){for(var i=0,n=0;n<e.length;n++)for(var r=0;r<t.length;r++)e[n]===t[r]&&i++;return i===t.length}},{key:"sortByAtomicNumberDesc",value:function(e){var t=e.map(function(e,t){return{index:t,value:e.atomicNumber.split(".").map(Number)}});return t.sort(function(e,t){for(var i=Math.min(t.value.length,e.value.length),n=0;n<i&&t.value[n]===e.value[n];)n++;return n===i?t.value.length-e.value.length:t.value[n]-e.value[n]}),t.map(function(t){return e[t.index]})}},{key:"deepCopy",value:function(t){for(var i,n=[],r=0;r<t.length;r++)i=t[r],n[r]=i instanceof Array?e.deepCopy(i):i;return n}}]),e}();i.default=o},{}],3:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=n(e("./ArrayHelper")),a=(n(e("./Vertex")),n(e("./Ring")),function(){function e(t){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"-";(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.element=1===t.length?t.toUpperCase():t,this.drawExplicit=!1,this.ringbonds=[],this.rings=[],this.bondType=i,this.branchBond=null,this.isBridge=!1,this.isBridgeNode=!1,this.originalRings=[],this.bridgedRing=null,this.anchoredRings=[],this.bracket=null,this.plane=0,this.attachedPseudoElements={},this.hasAttachedPseudoElements=!1,this.isDrawn=!0,this.isConnectedToRing=!1,this.neighbouringElements=[],this.isPartOfAromaticRing=t!==this.element,this.bondCount=0,this.chirality="",this.isStereoCenter=!1,this.priority=0,this.mainChain=!1,this.hydrogenDirection="down",this.subtreeDepth=1,this.hasHydrogen=!1}return r(e,[{key:"addNeighbouringElement",value:function(e){this.neighbouringElements.push(e)}},{key:"attachPseudoElement",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;null===i&&(i=0),null===n&&(n=0);var r=i+e+n;this.attachedPseudoElements[r]?this.attachedPseudoElements[r].count+=1:this.attachedPseudoElements[r]={element:e,count:1,hydrogenCount:i,previousElement:t,charge:n},this.hasAttachedPseudoElements=!0}},{key:"getAttachedPseudoElements",value:function(){var e={},t=this;return Object.keys(this.attachedPseudoElements).sort().forEach(function(i){e[i]=t.attachedPseudoElements[i]}),e}},{key:"getAttachedPseudoElementsCount",value:function(){return Object.keys(this.attachedPseudoElements).length}},{key:"isHeteroAtom",value:function(){return"C"!==this.element&&"H"!==this.element}},{key:"addAnchoredRing",value:function(e){o.default.contains(this.anchoredRings,{value:e})||this.anchoredRings.push(e)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"backupRings",value:function(){this.originalRings=Array(this.rings.length);for(var e=0;e<this.rings.length;e++)this.originalRings[e]=this.rings[e]}},{key:"restoreRings",value:function(){this.rings=Array(this.originalRings.length);for(var e=0;e<this.originalRings.length;e++)this.rings[e]=this.originalRings[e]}},{key:"haveCommonRingbond",value:function(e,t){for(var i=0;i<e.ringbonds.length;i++)for(var n=0;n<t.ringbonds.length;n++)if(e.ringbonds[i].id==t.ringbonds[n].id)return!0;return!1}},{key:"neighbouringElementsEqual",value:function(e){if(e.length!==this.neighbouringElements.length)return!1;e.sort(),this.neighbouringElements.sort();for(var t=0;t<this.neighbouringElements.length;t++)if(e[t]!==this.neighbouringElements[t])return!1;return!0}},{key:"getAtomicNumber",value:function(){return e.atomicNumbers[this.element]}},{key:"getMaxBonds",value:function(){return e.maxBonds[this.element]}}],[{key:"maxBonds",get:function(){return{C:4,N:3,O:2,P:3,S:2,B:3,F:1,I:1,Cl:1,Br:1}}},{key:"atomicNumbers",get:function(){return{H:1,He:2,Li:3,Be:4,B:5,b:5,C:6,c:6,N:7,n:7,O:8,o:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,p:15,S:16,s:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103,Rf:104,Db:105,Sg:106,Bh:107,Hs:108,Mt:109,Ds:110,Rg:111,Cn:112,Uut:113,Uuq:114,Uup:115,Uuh:116,Uus:117,Uuo:118}}},{key:"mass",get:function(){return{H:1,He:2,Li:3,Be:4,B:5,b:5,C:6,c:6,N:7,n:7,O:8,o:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,p:15,S:16,s:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103,Rf:104,Db:105,Sg:106,Bh:107,Hs:108,Mt:109,Ds:110,Rg:111,Cn:112,Uut:113,Uuq:114,Uup:115,Uuh:116,Uus:117,Uuo:118}}}]),e}());i.default=a},{"./ArrayHelper":2,"./Ring":11,"./Vertex":15}],4:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var r=Number.MAX_VALUE;Object.defineProperty(i,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=n(e("./MathHelper")),s=n(e("./Vector2")),l=(n(e("./Line")),n(e("./Vertex")),n(e("./Ring")),function(){function e(t,i,n){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.canvas="string"==typeof t||t instanceof String?document.getElementById(t):t,this.ctx=this.canvas.getContext("2d"),this.colors=i,this.opts=n,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.fontLarge=this.opts.fontSizeLarge+"pt Helvetica, Arial, sans-serif",this.fontSmall=this.opts.fontSizeSmall+"pt Helvetica, Arial, sans-serif",this.updateSize(this.opts.width,this.opts.height),this.ctx.font=this.fontLarge,this.hydrogenWidth=this.ctx.measureText("H").width,this.halfHydrogenWidth=this.hydrogenWidth/2,this.halfBondThickness=this.opts.bondThickness/2}return o(e,[{key:"updateSize",value:function(e,t){this.devicePixelRatio=window.devicePixelRatio||1,this.backingStoreRatio=this.ctx.webkitBackingStorePixelRatio||this.ctx.mozBackingStorePixelRatio||this.ctx.msBackingStorePixelRatio||this.ctx.oBackingStorePixelRatio||this.ctx.backingStorePixelRatio||1,this.ratio=this.devicePixelRatio/this.backingStoreRatio,1===this.ratio?(this.canvas.width=e*this.ratio,this.canvas.height=t*this.ratio):(this.canvas.width=e*this.ratio,this.canvas.height=t*this.ratio,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.ctx.setTransform(this.ratio,0,0,this.ratio,0,0))}},{key:"setTheme",value:function(e){this.colors=e}},{key:"scale",value:function(e){for(var t=-r,i=-r,n=r,o=r,a=0;a<e.length;a++)if(e[a].value.isDrawn){var s=e[a].position;t<s.x&&(t=s.x),i<s.y&&(i=s.y),n>s.x&&(n=s.x),o>s.y&&(o=s.y)}t+=20,i+=20,n-=20,o-=20,this.drawingWidth=t-n,this.drawingHeight=i-o;var l=this.canvas.offsetWidth/this.drawingWidth,h=this.canvas.offsetHeight/this.drawingHeight,c=l<h?l:h;this.ctx.scale(c,c),this.offsetX=-n,this.offsetY=-o,l<h?this.offsetY+=this.canvas.offsetHeight/(2*c)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*c)-this.drawingWidth/2}},{key:"reset",value:function(){this.ctx.setTransform(1,0,0,1,0,0)}},{key:"getColor",value:function(e){return(e=e.toUpperCase())in this.colors?this.colors[e]:this.colors.C}},{key:"drawCircle",value:function(e,t,i,n){var r=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],o=5<arguments.length&&void 0!==arguments[5]&&arguments[5],s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:"",l=this.ctx,h=this.offsetX,c=this.offsetY;l.save(),l.lineWidth=1.5,l.beginPath(),l.arc(e+h,t+c,i,0,a.default.twoPI,!0),l.closePath(),o?(r?(l.fillStyle="#f00",l.fill()):(l.strokeStyle="#f00",l.stroke()),this.drawDebugText(e,t,s)):r?(l.fillStyle=n,l.fill()):(l.strokeStyle=n,l.stroke()),l.restore()}},{key:"drawLine",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,n=this.ctx,r=this.offsetX,o=this.offsetY,a=e.clone().shorten(4),s=a.getLeftVector().clone(),l=a.getRightVector().clone();s.x+=r,s.y+=o,l.x+=r,l.y+=o,t||(n.save(),n.globalCompositeOperation="destination-out",n.beginPath(),n.moveTo(s.x,s.y),n.lineTo(l.x,l.y),n.lineCap="round",n.lineWidth=this.opts.bondThickness+1.2,n.strokeStyle=this.getColor("BACKGROUND"),n.stroke(),n.globalCompositeOperation="source-over",n.restore()),s=e.getLeftVector().clone(),l=e.getRightVector().clone(),s.x+=r,s.y+=o,l.x+=r,l.y+=o,n.save(),n.beginPath(),n.moveTo(s.x,s.y),n.lineTo(l.x,l.y),n.lineCap="round",n.lineWidth=this.opts.bondThickness;var h=this.ctx.createLinearGradient(s.x,s.y,l.x,l.y);h.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),h.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),t&&(n.setLineDash([1,1]),n.lineWidth=this.opts.bondThickness),1>i&&(n.globalAlpha=i),n.strokeStyle=h,n.stroke(),n.restore()}},{key:"drawWedge",value:function(e){if(!(1<arguments.length&&void 0!==arguments[1])||arguments[1],!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var t=this.ctx,i=this.offsetX,n=this.offsetY,r=e.clone().shorten(5),o=r.getLeftVector().clone(),a=r.getRightVector().clone();o.x+=i,o.y+=n,a.x+=i,a.y+=n,o=e.getLeftVector().clone(),a=e.getRightVector().clone(),o.x+=i,o.y+=n,a.x+=i,a.y+=n,t.save();var l=s.default.normals(o,a);l[0].normalize(),l[1].normalize();var h=o,c=a;e.getRightChiral()&&(h=a,c=o);var u=s.default.add(h,s.default.multiplyScalar(l[0],this.halfBondThickness)),d=s.default.add(c,s.default.multiplyScalar(l[0],1.5+this.halfBondThickness)),g=s.default.add(c,s.default.multiplyScalar(l[1],1.5+this.halfBondThickness)),p=s.default.add(h,s.default.multiplyScalar(l[1],this.halfBondThickness));t.beginPath(),t.moveTo(u.x,u.y),t.lineTo(d.x,d.y),t.lineTo(g.x,g.y),t.lineTo(p.x,p.y);var f=this.ctx.createRadialGradient(a.x,a.y,this.opts.bondLength,a.x,a.y,0);f.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),f.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),t.fillStyle=f,t.fill(),t.restore()}}},{key:"drawDashedWedge",value:function(e){if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var t=this.ctx,i=this.offsetX,n=this.offsetY,r=e.getLeftVector().clone(),o=e.getRightVector().clone();r.x+=i,r.y+=n,o.x+=i,o.y+=n,t.save();var a=s.default.normals(r,o);a[0].normalize(),a[1].normalize();var l,h,c,u,d=e.getRightChiral(),g=e.clone();d?(l=o,h=r,g.shortenRight(1),c=g.getRightVector().clone(),u=g.getLeftVector().clone()):(l=r,h=o,g.shortenLeft(1),c=g.getLeftVector().clone(),u=g.getRightVector().clone()),c.x+=i,c.y+=n,u.x+=i,u.y+=n;var p=s.default.subtract(h,l).normalize();t.strokeStyle=this.getColor("C"),t.lineCap="round",t.lineWidth=this.opts.bondThickness,t.beginPath();for(var f=e.getLength(),v=1.25/(f/(3*this.opts.bondThickness)),_=!1,y=0;1>y;y+=v){var m=s.default.multiplyScalar(p,y*f),b=s.default.add(l,m),x=1.5*y,w=s.default.multiplyScalar(a[0],x);!_&&.5<y&&(t.stroke(),t.beginPath(),t.strokeStyle=this.getColor(e.getRightElement())||this.getColor("C"),_=!0),b.subtract(w),t.moveTo(b.x,b.y),b.add(s.default.multiplyScalar(w,2)),t.lineTo(b.x,b.y)}t.stroke(),t.restore()}}},{key:"drawDebugText",value:function(e,t,i){var n=this.ctx;n.save(),n.font="5px Droid Sans, sans-serif",n.textAlign="start",n.textBaseline="top",n.fillStyle="#ff0000",n.fillText(i,e+this.offsetX,t+this.offsetY),n.restore()}},{key:"drawBall",value:function(e,t,i){var n=this.ctx;n.save(),n.beginPath(),n.arc(e+this.offsetX,t+this.offsetY,this.opts.bondLength/4.5,0,a.default.twoPI,!1),n.fillStyle=this.getColor(i),n.fill(),n.restore()}},{key:"drawPoint",value:function(e,t,i){var n=this.ctx,r=this.offsetX,o=this.offsetY;n.save(),n.globalCompositeOperation="destination-out",n.beginPath(),n.arc(e+r,t+o,1.5,0,a.default.twoPI,!0),n.closePath(),n.fill(),n.globalCompositeOperation="source-over",n.beginPath(),n.arc(e+this.offsetX,t+this.offsetY,.75,0,a.default.twoPI,!1),n.fillStyle=this.getColor(i),n.fill(),n.restore()}},{key:"drawText",value:function(e,t,i,n,r,o,s,l){var h=8<arguments.length&&void 0!==arguments[8]?arguments[8]:{},c=this.ctx,u=this.offsetX,d=this.offsetY;c.save(),c.textAlign="start",c.textBaseline="alphabetic";var g="",p=0;s&&(g=this.getChargeText(s),c.font=this.fontSmall,p=c.measureText(g).width);var f="0",v=0;0<l&&(f=l.toString(),c.font=this.fontSmall,v=c.measureText(f).width),1===s&&"N"===i&&h.hasOwnProperty("0O")&&h.hasOwnProperty("0O-1")&&(h={"0O":{element:"O",count:2,hydrogenCount:0,previousElement:"C",charge:""}},s=0),c.font=this.fontLarge,c.fillStyle=this.getColor("BACKGROUND");var _=c.measureText(i);_.totalWidth=_.width+p,_.height=parseInt(this.fontLarge,10);var y=_.width>this.opts.fontSizeLarge?_.width:this.opts.fontSizeLarge;y/=1.5,c.globalCompositeOperation="destination-out",c.beginPath(),c.arc(e+u,t+d,y,0,a.default.twoPI,!0),c.closePath(),c.fill(),c.globalCompositeOperation="source-over";var m=-_.width/2,b=-_.width/2;c.fillStyle=this.getColor(i),c.fillText(i,e+u+m,t+this.opts.halfFontSizeLarge+d),m+=_.width,s&&(c.font=this.fontSmall,c.fillText(g,e+u+m,t-this.opts.fifthFontSizeSmall+d),m+=p),0<l&&(c.font=this.fontSmall,c.fillText(f,e+u+b-v,t-this.opts.fifthFontSizeSmall+d),b-=v),c.font=this.fontLarge;var x=0,w=0;if(1===n){var k=e+u,S=t+d+this.opts.halfFontSizeLarge;b-=x=this.hydrogenWidth,"left"===r?k+=b:"right"===r?k+=m:"up"===r&&o?k+=m:"down"===r&&o?k+=m:"up"!==r||o?"down"===r&&!o&&(S+=this.opts.fontSizeLarge+this.opts.quarterFontSizeLarge,k-=this.halfHydrogenWidth):(S-=this.opts.fontSizeLarge+this.opts.quarterFontSizeLarge,k-=this.halfHydrogenWidth),c.fillText("H",k,S),m+=x}else if(1<n){var C=e+u,A=t+d+this.opts.halfFontSizeLarge;x=this.hydrogenWidth,c.font=this.fontSmall,b-=x+(w=c.measureText(n).width),"left"===r?C+=b:"right"===r?C+=m:"up"===r&&o?C+=m:"down"===r&&o?C+=m:"up"!==r||o?"down"===r&&!o&&(A+=this.opts.fontSizeLarge+this.opts.quarterFontSizeLarge,C-=this.halfHydrogenWidth):(A-=this.opts.fontSizeLarge+this.opts.quarterFontSizeLarge,C-=this.halfHydrogenWidth),c.font=this.fontLarge,c.fillText("H",C,A),c.font=this.fontSmall,c.fillText(n,C+this.halfHydrogenWidth+w,A+this.opts.fifthFontSizeSmall),m+=x+this.halfHydrogenWidth+w}for(var R in h)if(h.hasOwnProperty(R)){var T=0,z=0,P=h[R].element,L=h[R].count,B=h[R].hydrogenCount,I=h[R].charge;c.font=this.fontLarge,1<L&&0<B&&(T=c.measureText("(").width,z=c.measureText(")").width);var O=c.measureText(P).width,D=0,E="",N=0;x=0,0<B&&(x=this.hydrogenWidth),c.font=this.fontSmall,1<L&&(D=c.measureText(L).width),0!==I&&(E=this.getChargeText(I),N=c.measureText(E).width),w=0,1<B&&(w=c.measureText(B).width),c.font=this.fontLarge;var j=e+u,M=t+d+this.opts.halfFontSizeLarge;c.fillStyle=this.getColor(P),0<L&&(b-=D),1<L&&0<B&&("left"===r?(b-=z,c.fillText(")",j+b,M)):(c.fillText("(",j+m,M),m+=T)),"left"===r?(b-=O,c.fillText(P,j+b,M)):(c.fillText(P,j+m,M),m+=O),0<B&&("left"===r?(b-=x+w,c.fillText("H",j+b,M),1<B&&(c.font=this.fontSmall,c.fillText(B,j+b+x,M+this.opts.fifthFontSizeSmall))):(c.fillText("H",j+m,M),m+=x,1<B&&(c.font=this.fontSmall,c.fillText(B,j+m,M+this.opts.fifthFontSizeSmall),m+=w))),c.font=this.fontLarge,1<L&&0<B&&("left"===r?(b-=T,c.fillText("(",j+b,M)):(c.fillText(")",j+m,M),m+=z)),c.font=this.fontSmall,1<L&&("left"===r?c.fillText(L,j+b+T+z+x+w+O,M+this.opts.fifthFontSizeSmall):(c.fillText(L,j+m,M+this.opts.fifthFontSizeSmall),m+=D)),0!==I&&("left"===r?c.fillText(E,j+b+T+z+x+w+O,t-this.opts.fifthFontSizeSmall+d):(c.fillText(E,j+m,t-this.opts.fifthFontSizeSmall+d),m+=N))}c.restore()}},{key:"getChargeText",value:function(e){return 1===e?"+":2===e?"2+":-1===e?"-":-2===e?"2-":""}},{key:"drawDebugPoint",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"#f00";this.drawCircle(e,t,2,n,!0,!0,i)}},{key:"drawAromaticityRing",value:function(e){var t=this.ctx,i=a.default.apothemFromSideLength(this.opts.bondLength,e.getSize());t.save(),t.strokeStyle=this.getColor("C"),t.lineWidth=this.opts.bondThickness,t.beginPath(),t.arc(e.center.x+this.offsetX,e.center.y+this.offsetY,i-this.opts.bondSpacing,0,2*Math.PI,!0),t.closePath(),t.stroke(),t.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight)}}]),e}());i.default=l},{"./Line":8,"./MathHelper":9,"./Ring":11,"./Vector2":14,"./Vertex":15}],5:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}var o=Math.PI,a=Math.min;Object.defineProperty(i,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=n(e("./MathHelper")),h=n(e("./ArrayHelper")),c=n(e("./Vector2")),u=n(e("./Line")),d=(n(e("./Vertex")),n(e("./Edge"))),g=n(e("./Atom")),p=n(e("./Ring")),f=n(e("./RingConnection")),v=n(e("./CanvasWrapper")),_=n(e("./Graph")),y=n(e("./SSSR")),m=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.graph=null,this.doubleBondConfigCount=0,this.doubleBondConfig=null,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvasWrapper=null,this.totalOverlapScore=0,this.defaultOptions={width:500,height:500,bondThickness:.6,bondLength:15,shortBondLength:.85,bondSpacing:2.592,atomVisualization:"default",isomeric:!0,debug:!1,terminalCarbons:!1,explicitHydrogens:!1,overlapSensitivity:.42,overlapResolutionIterations:1,compactDrawing:!0,fontSizeLarge:5,fontSizeSmall:3,themes:{dark:{C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",H:"#fff",BACKGROUND:"#141414"},light:{C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",H:"#222",BACKGROUND:"#fff"}}},this.opts=this.extend(!0,this.defaultOptions,t),this.opts.halfBondSpacing=this.opts.bondSpacing/2,this.opts.bondLengthSq=this.opts.bondLength*this.opts.bondLength,this.opts.halfFontSizeLarge=this.opts.fontSizeLarge/2,this.opts.quarterFontSizeLarge=this.opts.fontSizeLarge/4,this.opts.fifthFontSizeSmall=this.opts.fontSizeSmall/5,this.theme=this.opts.themes.dark}return s(e,[{key:"extend",value:function(){var e=this,t={},i=!1,n=0,r=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(i=arguments[0],n++);for(var o,a=function(n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=i&&"[object Object]"===Object.prototype.toString.call(n[r])?e.extend(!0,t[r],n[r]):n[r])};n<r;n++)o=arguments[n],a(o);return t}},{key:"draw",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"light",n=3<arguments.length&&void 0!==arguments[3]&&arguments[3];if(this.data=e,this.canvasWrapper=new v.default(t,this.opts.themes[i],this.opts),this.infoOnly=n,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.graph=new _.default(e,this.opts.isomeric),this.rings=[],this.ringConnections=[],this.originalRings=[],this.originalRingConnections=[],this.bridgedRing=!1,this.doubleBondConfigCount=null,this.doubleBondConfig=null,this.initRings(),this.initHydrogens(),!this.infoOnly){this.position(),this.restoreRingInformation(),this.resolvePrimaryOverlaps();var r=this.getOverlapScore();this.totalOverlapScore=this.getOverlapScore().total;for(var o=0;o<this.opts.overlapResolutionIterations;o++)for(var a,s=0;s<this.graph.edges.length;s++)if(a=this.graph.edges[s],this.isEdgeRotatable(a)){var h=this.graph.getTreeDepth(a.sourceId,a.targetId),c=this.graph.getTreeDepth(a.targetId,a.sourceId),u=a.targetId,d=a.sourceId;if(h>c&&(u=a.sourceId,d=a.targetId),this.getSubtreeOverlapScore(d,u,r.vertexScores).value>this.opts.overlapSensitivity){var g=this.graph.vertices[u],p=this.graph.vertices[d],f=p.getNeighbours(u);if(1===f.length){var y=this.graph.vertices[f[0]],m=y.position.getRotateAwayFromAngle(g.position,p.position,l.default.toRad(120));this.rotateSubtree(y.id,p.id,m,p.position);var b=this.getOverlapScore().total;b>this.totalOverlapScore?this.rotateSubtree(y.id,p.id,-m,p.position):this.totalOverlapScore=b}else if(2===f.length){if(0!==p.value.rings.length&&0!==g.value.rings.length)continue;var x=this.graph.vertices[f[0]],w=this.graph.vertices[f[1]];if(1===x.value.rings.length&&1===w.value.rings.length){if(x.value.rings[0]!==w.value.rings[0])continue}else{if(0!==x.value.rings.length||0!==w.value.rings.length)continue;var k=x.position.getRotateAwayFromAngle(g.position,p.position,l.default.toRad(120)),S=w.position.getRotateAwayFromAngle(g.position,p.position,l.default.toRad(120));this.rotateSubtree(x.id,p.id,k,p.position),this.rotateSubtree(w.id,p.id,S,p.position);var C=this.getOverlapScore().total;C>this.totalOverlapScore?(this.rotateSubtree(x.id,p.id,-k,p.position),this.rotateSubtree(w.id,p.id,-S,p.position)):this.totalOverlapScore=C}}r=this.getOverlapScore()}}this.resolveSecondaryOverlaps(r.scores),this.opts.isomeric&&this.annotateStereochemistry(),this.opts.compactDrawing&&"default"===this.opts.atomVisualization&&this.initPseudoElements(),this.rotateDrawing(),this.canvasWrapper.scale(this.graph.vertices),this.drawEdges(this.opts.debug),this.drawVertices(this.opts.debug),this.canvasWrapper.reset()}}},{key:"edgeRingCount",value:function(e){var t=this.graph.edges[e],i=this.graph.vertices[t.sourceId],n=this.graph.vertices[t.targetId];return a(i.value.rings.length,n.value.rings.length)}},{key:"getBridgedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isBridged&&e.push(this.rings[t]);return e}},{key:"getFusedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isFused&&e.push(this.rings[t]);return e}},{key:"getSpiros",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isSpiro&&e.push(this.rings[t]);return e}},{key:"printRingInfo",value:function(){for(var e,t="",i=0;i<this.rings.length;i++)e=this.rings[i],t+=e.id+";",t+=e.members.length+";",t+=e.neighbours.length+";",t+=e.isSpiro?"true;":"false;",t+=e.isFused?"true;":"false;",t+=e.isBridged?"true;":"false;",t+=e.rings.length+";",t+="\n";return t}},{key:"rotateDrawing",value:function(){for(var e,t=0,i=0,n=0,r=0;r<this.graph.vertices.length;r++)if(e=this.graph.vertices[r],e.value.isDrawn)for(var o,a=r+1;a<this.graph.vertices.length;a++)if(o=this.graph.vertices[a],o.value.isDrawn){var s=e.position.distanceSq(o.position);s>n&&(n=s,t=r,i=a)}var l=-c.default.subtract(this.graph.vertices[t].position,this.graph.vertices[i].position).angle();if(!isNaN(l)){var h=l%.523599;.2617995>h?l-=h:l+=.523599-h;for(r=0;r<this.graph.vertices.length;r++)r!==i&&this.graph.vertices[r].position.rotateAround(l,this.graph.vertices[i].position);for(r=0;r<this.rings.length;r++)this.rings[r].center.rotateAround(l,this.graph.vertices[i].position)}}},{key:"getTotalOverlapScore",value:function(){return this.totalOverlapScore}},{key:"getRingCount",value:function(){return this.rings.length}},{key:"hasBridgedRing",value:function(){return this.bridgedRing}},{key:"getHeavyAtomCount",value:function(){for(var e=0,t=0;t<this.graph.vertices.length;t++)"H"!==this.graph.vertices[t].value.element&&e++;return e}},{key:"getRingbondType",value:function(e,t){if(1>e.value.getRingbondCount()||1>t.value.getRingbondCount())return null;for(var i=0;i<e.value.ringbonds.length;i++)for(var n=0;n<t.value.ringbonds.length;n++)if(e.value.ringbonds[i].id===t.value.ringbonds[n].id)return"-"===e.value.ringbonds[i].bondType?t.value.ringbonds[n].bond:e.value.ringbonds[i].bond;return null}},{key:"initRings",value:function(){for(var e,t=new Map,i=this.graph.vertices.length-1;0<=i;i--)if(e=this.graph.vertices[i],0!==e.value.ringbonds.length)for(var n,o=0;o<e.value.ringbonds.length;o++)if(n=e.value.ringbonds[o].id,t.has(n)){var a=e.id,s=t.get(n),l=this.graph.addEdge(new d.default(a,s,1)),h=this.graph.vertices[s];e.addRingbondChild(s,o),e.value.addNeighbouringElement(h.value.element),h.addRingbondChild(a,o),h.value.addNeighbouringElement(e.value.element),e.edges.push(l),h.edges.push(l),t.delete(n)}else t.set(n,e.id);var c=y.default.getRings(this.graph);if(null!==c){for(i=0;i<c.length;i++){var u=[].concat(r(c[i])),g=this.addRing(new p.default(u));for(o=0;o<u.length;o++)this.graph.vertices[u[o]].value.rings.push(g)}for(i=0;i<this.rings.length-1;i++)for(o=i+1;o<this.rings.length;o++){var v=this.rings[i],_=this.rings[o],m=new f.default(v,_);0<m.vertices.size&&this.addRingConnection(m)}var b;for(i=0;i<this.rings.length;i++)b=this.rings[i],b.neighbours=f.default.getNeighbours(this.ringConnections,b.id);var x;for(i=0;i<this.rings.length;i++)x=this.rings[i],this.graph.vertices[x.members[0]].value.addAnchoredRing(x.id);for(this.backupRingInformation();0<this.rings.length;){var w,k=-1;for(i=0;i<this.rings.length;i++)w=this.rings[i],this.isPartOfBridgedRing(w.id)&&!w.isBridged&&(k=w.id);if(-1===k)break;var S=this.getRing(k),C=this.getBridgedRingRings(S.id);this.bridgedRing=!0,this.createBridgedRing(C,S.members[0]);for(i=0;i<C.length;i++)this.removeRing(C[i])}}}},{key:"initHydrogens",value:function(){if(!this.opts.explicitHydrogens)for(var e,t=0;t<this.graph.vertices.length;t++)if(e=this.graph.vertices[t],"H"===e.value.element){var i=this.graph.vertices[e.neighbours[0]];i.value.hasHydrogen=!0,(!i.value.isStereoCenter||2>i.value.rings.length&&!i.value.bridgedRing||i.value.bridgedRing&&2>i.value.originalRings.length)&&(e.value.isDrawn=!1)}}},{key:"getBridgedRingRings",value:function(e){var t=[],i=this;return function e(n){var r=i.getRing(n);t.push(n);for(var o,a=0;a<r.neighbours.length;a++)o=r.neighbours[a],-1===t.indexOf(o)&&o!==n&&f.default.isBridge(i.ringConnections,i.graph.vertices,n,o)&&e(o)}(e),h.default.unique(t)}},{key:"isPartOfBridgedRing",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].containsRing(e)&&this.ringConnections[t].isBridge(this.graph.vertices))return!0;return!1}},{key:"createBridgedRing",value:function(e){for(var t,i=new Set,n=new Set,o=new Set,a=0;a<e.length;a++){(t=this.getRing(e[a])).isPartOfBridged=!0;for(var s=0;s<t.members.length;s++)n.add(t.members[s]);var l;for(s=0;s<t.neighbours.length;s++)l=t.neighbours[s],-1===e.indexOf(l)&&o.add(t.neighbours[s])}var c,u=new Set,d=!0,g=!1;try{for(var f,v=n[Symbol.iterator]();!(d=(f=v.next()).done);d=!0){var _=f.value,y=this.graph.vertices[_],m=h.default.intersection(e,y.value.rings);1===y.value.rings.length||1===m.length?i.add(y.id):u.add(y.id)}}catch(e){g=!0,c=e}finally{try{!d&&v.return&&v.return()}finally{if(g)throw c}}var b,x=[],w=!0,k=!1;try{for(var S,C=u[Symbol.iterator]();!(w=(S=C.next()).done);w=!0){for(var A=S.value,R=this.graph.vertices[A],T=!1,z=0;z<R.edges.length;z++)1===this.edgeRingCount(R.edges[z])&&(T=!0);T?(R.value.isBridgeNode=!0,i.add(R.id)):(R.value.isBridge=!0,i.add(R.id))}}catch(e){k=!0,b=e}finally{try{!w&&C.return&&C.return()}finally{if(k)throw b}}var P=new p.default([].concat(r(i)));P.isBridged=!0,P.neighbours=[].concat(r(o));for(a=0;a<e.length;a++)P.rings.push(this.getRing(e[a]).clone());this.addRing(P);for(a=0;a<P.members.length;a++)this.graph.vertices[P.members[a]].value.bridgedRing=P.id;var L;for(a=0;a<x.length;a++)L=this.graph.vertices[x[a]],L.value.rings=[];var B,I=!0,O=!1;try{for(var D,E=i[Symbol.iterator]();!(I=(D=E.next()).done);I=!0){var N=D.value,j=this.graph.vertices[N];j.value.rings=h.default.removeAll(j.value.rings,e),j.value.rings.push(P.id)}}catch(e){O=!0,B=e}finally{try{!I&&E.return&&E.return()}finally{if(O)throw B}}for(a=0;a<e.length;a++)for(s=a+1;s<e.length;s++)this.removeRingConnectionsBetween(e[a],e[s]);var M,F=!0,V=!1;try{for(var H,W=o[Symbol.iterator]();!(F=(H=W.next()).done);F=!0){var K=H.value,q=this.getRingConnections(K,e);for(s=0;s<q.length;s++)this.getRingConnection(q[s]).updateOther(P.id,K);this.getRing(K).neighbours.push(P.id)}}catch(e){V=!0,M=e}finally{try{!F&&W.return&&W.return()}finally{if(V)throw M}}return P}},{key:"areVerticesInSameRing",value:function(e,t){for(var i=0;i<e.value.rings.length;i++)for(var n=0;n<t.value.rings.length;n++)if(e.value.rings[i]===t.value.rings[n])return!0;return!1}},{key:"getCommonRings",value:function(e,t){for(var i=[],n=0;n<e.value.rings.length;n++)for(var r=0;r<t.value.rings.length;r++)e.value.rings[n]==t.value.rings[r]&&i.push(e.value.rings[n]);return i}},{key:"getLargestOrAromaticCommonRing",value:function(e,t){for(var i=this.getCommonRings(e,t),n=0,r=null,o=0;o<i.length;o++){var a=this.getRing(i[o]),s=a.getSize();if(a.isBenzeneLike(this.graph.vertices))return a;s>n&&(n=s,r=a)}return r}},{key:"getVerticesAt",value:function(e,t,i){for(var n,r=[],o=0;o<this.graph.vertices.length;o++)if(n=this.graph.vertices[o],n.id!==i&&n.positioned){e.distanceSq(n.position)<=t*t&&r.push(n.id)}return r}},{key:"getClosestVertex",value:function(e){for(var t,i=99999,n=null,r=0;r<this.graph.vertices.length;r++)if(t=this.graph.vertices[r],t.id!==e.id){var o=e.position.distanceSq(t.position);o<i&&(i=o,n=t)}return n}},{key:"addRing",value:function(e){return e.id=this.ringIdCounter++,this.rings.push(e),e.id}},{key:"removeRing",value:function(e){this.rings=this.rings.filter(function(t){return t.id!==e}),this.ringConnections=this.ringConnections.filter(function(t){return t.firstRingId!==e&&t.secondRingId!==e});for(var t,i=0;i<this.rings.length;i++)t=this.rings[i],t.neighbours=t.neighbours.filter(function(t){return t!==e})}},{key:"getRing",value:function(e){for(var t=0;t<this.rings.length;t++)if(this.rings[t].id==e)return this.rings[t]}},{key:"addRingConnection",value:function(e){return e.id=this.ringConnectionIdCounter++,this.ringConnections.push(e),e.id}},{key:"removeRingConnection",value:function(e){this.ringConnections=this.ringConnections.filter(function(t){return t.id!==e})}},{key:"removeRingConnectionsBetween",value:function(e,t){for(var i,n=[],r=0;r<this.ringConnections.length;r++)i=this.ringConnections[r],(i.firstRingId===e&&i.secondRingId===t||i.firstRingId===t&&i.secondRingId===e)&&n.push(i.id);for(r=0;r<n.length;r++)this.removeRingConnection(n[r])}},{key:"getRingConnection",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].id==e)return this.ringConnections[t]}},{key:"getRingConnections",value:function(e,t){for(var i,n=[],r=0;r<this.ringConnections.length;r++){i=this.ringConnections[r];for(var o,a=0;a<t.length;a++)o=t[a],(i.firstRingId===e&&i.secondRingId===o||i.firstRingId===o&&i.secondRingId===e)&&n.push(i.id)}return n}},{key:"getOverlapScore",value:function(){for(var e=0,t=new Float32Array(this.graph.vertices.length),i=0;i<this.graph.vertices.length;i++)t[i]=0;var n;for(i=0;i<this.graph.vertices.length;i++)for(n=this.graph.vertices.length;--n>i;){var r=this.graph.vertices[i],o=this.graph.vertices[n];if(r.value.isDrawn&&o.value.isDrawn){var a=c.default.subtract(r.position,o.position).lengthSq();if(a<this.opts.bondLengthSq){var s=(this.opts.bondLength-Math.sqrt(a))/this.opts.bondLength;e+=s,t[i]+=s,t[n]+=s}}}var l=[];for(i=0;i<this.graph.vertices.length;i++)l.push({id:i,score:t[i]});return l.sort(function(e,t){return t.score-e.score}),{total:e,scores:l,vertexScores:t}}},{key:"chooseSide",value:function(e,t,i){for(var n,r=e.getNeighbours(t.id),o=t.getNeighbours(e.id),a=r.length,s=o.length,l=h.default.merge(r,o),c=[0,0],u=0;u<l.length;u++)n=this.graph.vertices[l[u]].position,n.sameSideAs(e.position,t.position,i[0])?c[0]++:c[1]++;var d,g=[0,0];for(u=0;u<this.graph.vertices.length;u++)d=this.graph.vertices[u].position,d.sameSideAs(e.position,t.position,i[0])?g[0]++:g[1]++;return{totalSideCount:g,totalPosition:g[0]>g[1]?0:1,sideCount:c,position:c[0]>c[1]?0:1,anCount:a,bnCount:s}}},{key:"setRingCenter",value:function(e){for(var t=e.getSize(),i=new c.default(0,0),n=0;n<t;n++)i.add(this.graph.vertices[e.members[n]].position);e.center=i.divide(t)}},{key:"getSubringCenter",value:function(e,t){for(var i=t.value.originalRings,n=e.center,r=Number.MAX_VALUE,o=0;o<i.length;o++)for(var a=0;a<e.rings.length;a++)i[o]===e.rings[a].id&&e.rings[a].getSize()<r&&(n=e.rings[a].center,r=e.rings[a].getSize());return n}},{key:"drawEdges",value:function(e){var t=this,i=Array(this.graph.edges.length);if(i.fill(!1),this.graph.traverseBF(0,function(n){for(var r,o=t.graph.getEdges(n.id),a=0;a<o.length;a++)r=o[a],i[r]||(i[r]=!0,t.drawEdge(r,e))}),!this.bridgedRing)for(var n,r=0;r<this.rings.length;r++)n=this.rings[r],this.isRingAromatic(n)&&this.canvasWrapper.drawAromaticityRing(n)}},{key:"drawEdge",value:function(e,t){var i=this,n=this.graph.edges[e],r=this.graph.vertices[n.sourceId],o=this.graph.vertices[n.targetId],a=r.value.element,s=o.value.element;if(r.value.isDrawn&&o.value.isDrawn||"default"!==this.opts.atomVisualization){var l=r.position,d=o.position,g=this.getEdgeNormals(n),p=h.default.clone(g);if(p[0].multiplyScalar(10).add(l),p[1].multiplyScalar(10).add(l),"="===n.bondType||"="===this.getRingbondType(r,o)||n.isPartOfAromaticRing&&this.bridgedRing){var f=this.areVerticesInSameRing(r,o),v=this.chooseSide(r,o,p);if(f){var _=this.getLargestOrAromaticCommonRing(r,o).center;g[0].multiplyScalar(i.opts.bondSpacing),g[1].multiplyScalar(i.opts.bondSpacing);var y=null;(y=_.sameSideAs(r.position,o.position,c.default.add(l,g[0]))?new u.default(c.default.add(l,g[0]),c.default.add(d,g[0]),a,s):new u.default(c.default.add(l,g[1]),c.default.add(d,g[1]),a,s)).shorten(this.opts.bondLength-this.opts.shortBondLength*this.opts.bondLength),n.isPartOfAromaticRing?this.canvasWrapper.drawLine(y,!0):this.canvasWrapper.drawLine(y),this.canvasWrapper.drawLine(new u.default(l,d,a,s))}else if(n.center||r.isTerminal()&&o.isTerminal()){g[0].multiplyScalar(i.opts.halfBondSpacing),g[1].multiplyScalar(i.opts.halfBondSpacing);var m=new u.default(c.default.add(l,g[0]),c.default.add(d,g[0]),a,s),b=new u.default(c.default.add(l,g[1]),c.default.add(d,g[1]),a,s);this.canvasWrapper.drawLine(m),this.canvasWrapper.drawLine(b)}else if(0==v.anCount&&1<v.bnCount||0==v.bnCount&&1<v.anCount){g[0].multiplyScalar(i.opts.halfBondSpacing),g[1].multiplyScalar(i.opts.halfBondSpacing);var x=new u.default(c.default.add(l,g[0]),c.default.add(d,g[0]),a,s),w=new u.default(c.default.add(l,g[1]),c.default.add(d,g[1]),a,s);this.canvasWrapper.drawLine(x),this.canvasWrapper.drawLine(w)}else if(v.sideCount[0]>v.sideCount[1]){g[0].multiplyScalar(i.opts.bondSpacing),g[1].multiplyScalar(i.opts.bondSpacing);var k=new u.default(c.default.add(l,g[0]),c.default.add(d,g[0]),a,s);k.shorten(this.opts.bondLength-this.opts.shortBondLength*this.opts.bondLength),this.canvasWrapper.drawLine(k),this.canvasWrapper.drawLine(new u.default(l,d,a,s))}else if(v.sideCount[0]<v.sideCount[1]){g[0].multiplyScalar(i.opts.bondSpacing),g[1].multiplyScalar(i.opts.bondSpacing);var S=new u.default(c.default.add(l,g[1]),c.default.add(d,g[1]),a,s);S.shorten(this.opts.bondLength-this.opts.shortBondLength*this.opts.bondLength),this.canvasWrapper.drawLine(S),this.canvasWrapper.drawLine(new u.default(l,d,a,s))}else if(v.totalSideCount[0]>v.totalSideCount[1]){g[0].multiplyScalar(i.opts.bondSpacing),g[1].multiplyScalar(i.opts.bondSpacing);var C=new u.default(c.default.add(l,g[0]),c.default.add(d,g[0]),a,s);C.shorten(this.opts.bondLength-this.opts.shortBondLength*this.opts.bondLength),this.canvasWrapper.drawLine(C),this.canvasWrapper.drawLine(new u.default(l,d,a,s))}else if(v.totalSideCount[0]<=v.totalSideCount[1]){g[0].multiplyScalar(i.opts.bondSpacing),g[1].multiplyScalar(i.opts.bondSpacing);var A=new u.default(c.default.add(l,g[1]),c.default.add(d,g[1]),a,s);A.shorten(this.opts.bondLength-this.opts.shortBondLength*this.opts.bondLength),this.canvasWrapper.drawLine(A),this.canvasWrapper.drawLine(new u.default(l,d,a,s))}}else if("#"===n.bondType){g[0].multiplyScalar(i.opts.bondSpacing/1.5),g[1].multiplyScalar(i.opts.bondSpacing/1.5);var R=new u.default(c.default.add(l,g[0]),c.default.add(d,g[0]),a,s),T=new u.default(c.default.add(l,g[1]),c.default.add(d,g[1]),a,s);this.canvasWrapper.drawLine(R),this.canvasWrapper.drawLine(T),this.canvasWrapper.drawLine(new u.default(l,d,a,s))}else if("."===n.bondType);else{var z=r.value.isStereoCenter,P=o.value.isStereoCenter;"up"===n.wedge?this.canvasWrapper.drawWedge(new u.default(l,d,a,s,z,P)):"down"===n.wedge?this.canvasWrapper.drawDashedWedge(new u.default(l,d,a,s,z,P)):this.canvasWrapper.drawLine(new u.default(l,d,a,s,z,P))}if(t){var L=c.default.midpoint(l,d);this.canvasWrapper.drawDebugText(L.x,L.y,"e: "+e)}}}},{key:"drawVertices",value:function(e){var t=this.graph.vertices.length;for(t=0;t<this.graph.vertices.length;t++){var i=this.graph.vertices[t],n=i.value,r=0,a=0,s=this.getBondCount(i),l=n.element,u=g.default.maxBonds[l]-s,d=i.getTextDirection(this.graph.vertices),p=(this.opts.terminalCarbons||"C"!==l||n.hasAttachedPseudoElements)&&i.isTerminal(),f="C"===n.element;if(n.bracket&&(u=n.bracket.hcount,r=n.bracket.charge,a=n.bracket.isotope),"allballs"===this.opts.atomVisualization)this.canvasWrapper.drawBall(i.position.x,i.position.y,l);else if(n.isDrawn&&(!f||n.drawExplicit||p||n.hasAttachedPseudoElements)||1===this.graph.vertices.length)"default"===this.opts.atomVisualization?this.canvasWrapper.drawText(i.position.x,i.position.y,l,u,d,p,r,a,n.getAttachedPseudoElements()):"balls"===this.opts.atomVisualization&&this.canvasWrapper.drawBall(i.position.x,i.position.y,l);else if(2===i.getNeighbourCount()&&1==i.forcePositioned){var v=this.graph.vertices[i.neighbours[0]].position,_=this.graph.vertices[i.neighbours[1]].position,y=c.default.threePointangle(i.position,v,_);.1>Math.abs(o-y)&&this.canvasWrapper.drawPoint(i.position.x,i.position.y,l)}if(e){var m="v: "+i.id+" "+h.default.print(n.ringbonds);this.canvasWrapper.drawDebugText(i.position.x,i.position.y,m)}}if(this.opts.debug){var b;for(t=0;t<this.rings.length;t++)b=this.rings[t].center,this.canvasWrapper.drawDebugPoint(b.x,b.y,"r: "+this.rings[t].id)}}},{key:"position",value:function(){for(var e=null,t=0;t<this.graph.vertices.length;t++)if(null!==this.graph.vertices[t].value.bridgedRing){e=this.graph.vertices[t];break}for(t=0;t<this.rings.length;t++)this.rings[t].isBridged&&(e=this.graph.vertices[this.rings[t].members[0]]);0<this.rings.length&&null===e&&(e=this.graph.vertices[this.rings[0].members[0]]),null===e&&(e=this.graph.vertices[0]),this.createNextBond(e,null,0)}},{key:"backupRingInformation",value:function(){this.originalRings=[],this.originalRingConnections=[];for(var e=0;e<this.rings.length;e++)this.originalRings.push(this.rings[e]);for(e=0;e<this.ringConnections.length;e++)this.originalRingConnections.push(this.ringConnections[e]);for(e=0;e<this.graph.vertices.length;e++)this.graph.vertices[e].value.backupRings()}},{key:"restoreRingInformation",value:function(){var e=this.getBridgedRings();this.rings=[],this.ringConnections=[];for(var t,i=0;i<e.length;i++){t=e[i];for(var n,r=0;r<t.rings.length;r++)n=t.rings[r],this.originalRings[n.id].center=n.center}for(i=0;i<this.originalRings.length;i++)this.rings.push(this.originalRings[i]);for(i=0;i<this.originalRingConnections.length;i++)this.ringConnections.push(this.originalRingConnections[i]);for(i=0;i<this.graph.vertices.length;i++)this.graph.vertices[i].value.restoreRings()}},{key:"createRing",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;if(!e.positioned){t=t||new c.default(0,0);var r=e.getOrderedNeighbours(this.ringConnections),o=i?c.default.subtract(i.position,t).angle():0,a=l.default.polyCircumradius(this.opts.bondLength,e.getSize()),s=l.default.centralAngle(e.getSize());e.centralAngle=s;var h=o,u=this,d=i?i.id:null;if(-1===e.members.indexOf(d)&&(i&&(i.positioned=!1),d=e.members[0]),e.isBridged){this.graph.kkLayout(e.members.slice(),t,i.id,e,this.opts.bondLength),e.positioned=!0,this.setRingCenter(e),t=e.center;for(var g=0;g<e.rings.length;g++)this.setRingCenter(e.rings[g])}else e.eachMember(this.graph.vertices,function(i){var n=u.graph.vertices[i];n.positioned||n.setPosition(t.x+Math.cos(h)*a,t.y+Math.sin(h)*a),h+=s,(!e.isBridged||3>e.rings.length)&&(n.angle=h,n.positioned=!0)},d,n?n.id:null);e.positioned=!0,e.center=t;var p;for(g=0;g<r.length;g++)if(p=this.getRing(r[g].neighbour),!p.positioned){var v=f.default.getVertices(this.ringConnections,e.id,p.id);if(2===v.length){e.isFused=!0,p.isFused=!0;var _=this.graph.vertices[v[0]],y=this.graph.vertices[v[1]],m=c.default.midpoint(_.position,y.position),b=c.default.normals(_.position,y.position);b[0].normalize(),b[1].normalize();var x=l.default.polyCircumradius(this.opts.bondLength,p.getSize()),w=l.default.apothem(x,p.getSize());b[0].multiplyScalar(w).add(m),b[1].multiplyScalar(w).add(m);var k=b[0];c.default.subtract(t,b[1]).lengthSq()>c.default.subtract(t,b[0]).lengthSq()&&(k=b[1]);var S=c.default.subtract(_.position,k),C=c.default.subtract(y.position,k);-1===S.clockwise(C)?!p.positioned&&this.createRing(p,k,_,y):!p.positioned&&this.createRing(p,k,y,_)}else if(1===v.length){e.isSpiro=!0,p.isSpiro=!0;var A=this.graph.vertices[v[0]],R=c.default.subtract(t,A.position);R.invert(),R.normalize();var T=l.default.polyCircumradius(this.opts.bondLength,p.getSize());R.multiplyScalar(T),R.add(A.position),p.positioned||this.createRing(p,R,A)}}for(g=0;g<e.members.length;g++)for(var z,P=this.graph.vertices[e.members[g]],L=P.neighbours,B=0;B<L.length;B++)z=this.graph.vertices[L[B]],!z.positioned&&(z.value.isConnectedToRing=!0,this.createNextBond(z,P,0))}}},{key:"rotateSubtree",value:function(e,t,i,n){var r=this;this.graph.traverseTree(e,t,function(e){e.position.rotateAround(i,n);for(var t,o=0;o<e.value.anchoredRings.length;o++)t=r.rings[e.value.anchoredRings[o]],t&&t.center.rotateAround(i,n)})}},{key:"getSubtreeOverlapScore",value:function(e,t,i){var n=this,r=0,o=new c.default(0,0),a=0;return this.graph.traverseTree(e,t,function(e){if(e.value.isDrawn){var t=i[e.id];t>n.opts.overlapSensitivity&&(r+=t,a++);var s=n.graph.vertices[e.id].position.clone();s.multiplyScalar(t),o.add(s)}}),o.divide(r),{value:r/a,center:o}}},{key:"getCurrentCenterOfMass",value:function(){for(var e,t=new c.default(0,0),i=0,n=0;n<this.graph.vertices.length;n++)e=this.graph.vertices[n],e.positioned&&(t.add(e.position),i++);return t.divide(i)}},{key:"getCurrentCenterOfMassInNeigbourhood",value:function(e){for(var t,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:2*this.opts.bondLength,n=new c.default(0,0),r=0,o=0;o<this.graph.vertices.length;o++)t=this.graph.vertices[o],t.positioned&&e.distanceSq(t.position)<i*i&&(n.add(t.position),r++);return n.divide(r)}},{key:"resolvePrimaryOverlaps",value:function(){for(var e,t=[],i=Array(this.graph.vertices.length),n=0;n<this.rings.length;n++){e=this.rings[n];for(var r,a=0;a<e.members.length;a++)if(r=this.graph.vertices[e.members[a]],!i[r.id]){i[r.id]=!0;var s=this.getNonRingNeighbours(r.id);if(1<s.length){for(var l=[],h=0;h<r.value.rings.length;h++)l.push(r.value.rings[h]);t.push({common:r,rings:l,vertices:s})}else if(1===s.length&&2===r.value.rings.length){var c=[];for(h=0;h<r.value.rings.length;h++)c.push(r.value.rings[h]);t.push({common:r,rings:c,vertices:s})}}}var u;for(n=0;n<t.length;n++)if(u=t[n],2===u.vertices.length){var d=u.vertices[0],g=u.vertices[1];if(!d.value.isDrawn||!g.value.isDrawn)continue;var p=(2*o-this.getRing(u.rings[0]).getAngle())/6;this.rotateSubtree(d.id,u.common.id,p,u.common.position),this.rotateSubtree(g.id,u.common.id,-p,u.common.position);var f=this.getOverlapScore(),v=this.getSubtreeOverlapScore(d.id,u.common.id,f.vertexScores),_=this.getSubtreeOverlapScore(g.id,u.common.id,f.vertexScores),y=v.value+_.value;this.rotateSubtree(d.id,u.common.id,-2*p,u.common.position),this.rotateSubtree(g.id,u.common.id,2*p,u.common.position),f=this.getOverlapScore(),v=this.getSubtreeOverlapScore(d.id,u.common.id,f.vertexScores),_=this.getSubtreeOverlapScore(g.id,u.common.id,f.vertexScores),v.value+_.value>y&&(this.rotateSubtree(d.id,u.common.id,2*p,u.common.position),this.rotateSubtree(g.id,u.common.id,-2*p,u.common.position))}else 1!==u.vertices.length||u.rings.length}},{key:"resolveSecondaryOverlaps",value:function(e){for(var t=0;t<e.length;t++)if(e[t].score>this.opts.overlapSensitivity){var i=this.graph.vertices[e[t].id];if(i.isTerminal()){var n=this.getClosestVertex(i);if(n){var r;r=n.isTerminal()?0===n.id?this.graph.vertices[1].position:n.previousPosition:0===n.id?this.graph.vertices[1].position:n.position;var o=0===i.id?this.graph.vertices[1].position:i.previousPosition;i.position.rotateAwayFrom(r,o,l.default.toRad(20))}}}}},{key:"getLastVertexWithAngle",value:function(e){for(var t=0,i=null;!t&&e;)i=this.graph.vertices[e],t=i.angle,e=i.parentVertexId;return i}},{key:"createNextBond",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]&&arguments[3],r=4<arguments.length&&void 0!==arguments[4]&&arguments[4];if(!e.positioned||r){var o=!1;if(t){var s=this.graph.getEdge(e.id,t.id);("/"===s.bondType||"\\"===s.bondType)&&1==++this.doubleBondConfigCount%2&&null===this.doubleBondConfig&&(this.doubleBondConfig=s.bondType,o=!0,null===t.parentVertexId&&e.value.branchBond&&("/"===this.doubleBondConfig?this.doubleBondConfig="\\":"\\"===this.doubleBondConfig&&(this.doubleBondConfig="/")))}if(!r)if(t)if(0<t.value.rings.length){var u=t.neighbours,d=null,g=new c.default(0,0);if(null===t.value.bridgedRing&&1<t.value.rings.length)for(var p,f=0;f<u.length;f++)if(p=this.graph.vertices[u[f]],h.default.containsAll(p.value.rings,t.value.rings)){d=p;break}if(null===d){var v;for(f=0;f<u.length;f++)v=this.graph.vertices[u[f]],v.positioned&&this.areVerticesInSameRing(v,t)&&g.add(c.default.subtract(v.position,t.position));g.invert().normalize().multiplyScalar(this.opts.bondLength).add(t.position)}else g=d.position.clone().rotateAround(Math.PI,t.position);e.previousPosition=t.position,e.setPositionFromVector(g),e.positioned=!0}else{var _=new c.default(this.opts.bondLength,0);_.rotate(i),_.add(t.position),e.setPositionFromVector(_),e.previousPosition=t.position,e.positioned=!0}else{var y=new c.default(this.opts.bondLength,0);y.rotate(l.default.toRad(-60)),e.previousPosition=y,e.setPosition(this.opts.bondLength,0),e.angle=l.default.toRad(-60),null===e.value.bridgedRing&&(e.positioned=!0)}if(null!==e.value.bridgedRing){var m=this.getRing(e.value.bridgedRing);if(!m.positioned){var b=c.default.subtract(e.previousPosition,e.position);b.invert(),b.normalize();var x=l.default.polyCircumradius(this.opts.bondLength,m.members.length);b.multiplyScalar(x),b.add(e.position),this.createRing(m,b,e)}}else if(0<e.value.rings.length){var w=this.getRing(e.value.rings[0]);if(!w.positioned){var k=c.default.subtract(e.previousPosition,e.position);k.invert(),k.normalize();var S=l.default.polyCircumradius(this.opts.bondLength,w.getSize());k.multiplyScalar(S),k.add(e.position),this.createRing(w,k,e)}}else{e.value.isStereoCenter;var C=e.getNeighbours(),A=[];for(f=0;f<C.length;f++)this.graph.vertices[C[f]].value.isDrawn&&A.push(C[f]);t&&(A=h.default.remove(A,t.id));var R=e.getAngle();if(1===A.length){var T=this.graph.vertices[A[0]];if("#"===e.value.bondType||t&&"#"===t.value.bondType||"="===e.value.bondType&&t&&0===t.value.rings.length&&"="===t.value.bondType&&"-"!==e.value.branchBond){if(e.value.drawExplicit=!1,t)this.graph.getEdge(e.id,t.id).center=!0;this.graph.getEdge(e.id,T.id).center=!0,("#"===e.value.bondType||t&&"#"===t.value.bondType)&&(T.angle=0),T.drawExplicit=!0,this.createNextBond(T,e,R+T.angle)}else if(t&&0<t.value.rings.length){var z=l.default.toRad(60),P=-z,L=new c.default(this.opts.bondLength,0),B=new c.default(this.opts.bondLength,0);L.rotate(z).add(e.position),B.rotate(P).add(e.position);var I=this.getCurrentCenterOfMass(),O=L.distanceSq(I),D=B.distanceSq(I);T.angle=O<D?P:z,this.createNextBond(T,e,R+T.angle)}else{var E=e.angle;if(t&&3<t.neighbours.length)E=0<E?a(1.0472,E):0>E?Math.max(-1.0472,E):1.0472;else if(!E){(E=this.getLastVertexWithAngle(e.id).angle)||(E=1.0472)}if(t&&!o){var N=this.graph.getEdge(e.id,T.id).bondType;"/"===N?("/"===this.doubleBondConfig||"\\"===this.doubleBondConfig&&(E=-E),this.doubleBondConfig=null):"\\"===N&&("/"===this.doubleBondConfig?E=-E:this.doubleBondConfig,this.doubleBondConfig=null)}T.angle=n?E:-E,this.createNextBond(T,e,R+T.angle)}}else if(2===A.length){var j=e.angle;j||(j=1.0472);var M=this.graph.getTreeDepth(A[0],e.id),F=this.graph.getTreeDepth(A[1],e.id),V=this.graph.vertices[A[0]],H=this.graph.vertices[A[1]];V.value.subtreeDepth=M,H.value.subtreeDepth=F;var W=this.graph.getTreeDepth(t?t.id:null,e.id);t&&(t.value.subtreeDepth=W);var K=0,q=1;"C"===H.value.element&&"C"!==V.value.element&&1<F&&5>M?(K=1,q=0):"C"!==H.value.element&&"C"===V.value.element&&1<M&&5>F?(K=0,q=1):F>M&&(K=1,q=0);var U=this.graph.vertices[A[K]],G=this.graph.vertices[A[q]],Y=(this.graph.getEdge(e.id,U.id),this.graph.getEdge(e.id,G.id),!1);W<M&&W<F&&(Y=!0),G.angle=j,U.angle=-j,"\\"===this.doubleBondConfig?"\\"===G.value.branchBond&&(G.angle=-j,U.angle=j):"/"===this.doubleBondConfig&&"/"===G.value.branchBond&&(G.angle=-j,U.angle=j),this.createNextBond(G,e,R+G.angle,Y),this.createNextBond(U,e,R+U.angle,Y)}else if(3===A.length){var X=this.graph.getTreeDepth(A[0],e.id),Z=this.graph.getTreeDepth(A[1],e.id),$=this.graph.getTreeDepth(A[2],e.id),J=this.graph.vertices[A[0]],Q=this.graph.vertices[A[1]],ee=this.graph.vertices[A[2]];J.value.subtreeDepth=X,Q.value.subtreeDepth=Z,ee.value.subtreeDepth=$,Z>X&&Z>$?(J=this.graph.vertices[A[1]],Q=this.graph.vertices[A[0]],ee=this.graph.vertices[A[2]]):$>X&&$>Z&&(J=this.graph.vertices[A[2]],Q=this.graph.vertices[A[0]],ee=this.graph.vertices[A[1]]),t&&1>t.value.rings.length&&1>J.value.rings.length&&1>Q.value.rings.length&&1>ee.value.rings.length&&1===this.graph.getTreeDepth(Q.id,e.id)&&1===this.graph.getTreeDepth(ee.id,e.id)&&1<this.graph.getTreeDepth(J.id,e.id)?(J.angle=-e.angle,0<=e.angle?(Q.angle=l.default.toRad(30),ee.angle=l.default.toRad(90)):(Q.angle=-l.default.toRad(30),ee.angle=-l.default.toRad(90)),this.createNextBond(J,e,R+J.angle),this.createNextBond(Q,e,R+Q.angle),this.createNextBond(ee,e,R+ee.angle)):(J.angle=0,Q.angle=l.default.toRad(90),ee.angle=-l.default.toRad(90),this.createNextBond(J,e,R+J.angle),this.createNextBond(Q,e,R+Q.angle),this.createNextBond(ee,e,R+ee.angle))}else if(4===A.length){var te=this.graph.getTreeDepth(A[0],e.id),ie=this.graph.getTreeDepth(A[1],e.id),ne=this.graph.getTreeDepth(A[2],e.id),re=this.graph.getTreeDepth(A[3],e.id),oe=this.graph.vertices[A[0]],ae=this.graph.vertices[A[1]],se=this.graph.vertices[A[2]],le=this.graph.vertices[A[3]];oe.value.subtreeDepth=te,ae.value.subtreeDepth=ie,se.value.subtreeDepth=ne,le.value.subtreeDepth=re,ie>te&&ie>ne&&ie>re?(oe=this.graph.vertices[A[1]],ae=this.graph.vertices[A[0]],se=this.graph.vertices[A[2]],le=this.graph.vertices[A[3]]):ne>te&&ne>ie&&ne>re?(oe=this.graph.vertices[A[2]],ae=this.graph.vertices[A[0]],se=this.graph.vertices[A[1]],le=this.graph.vertices[A[3]]):re>te&&re>ie&&re>ne&&(oe=this.graph.vertices[A[3]],ae=this.graph.vertices[A[0]],se=this.graph.vertices[A[1]],le=this.graph.vertices[A[2]]),oe.angle=-l.default.toRad(36),ae.angle=l.default.toRad(36),se.angle=-l.default.toRad(108),le.angle=l.default.toRad(108),this.createNextBond(oe,e,R+oe.angle),this.createNextBond(ae,e,R+ae.angle),this.createNextBond(se,e,R+se.angle),this.createNextBond(le,e,R+le.angle)}}}}},{key:"getCommonRingbondNeighbour",value:function(e){for(var t,i=e.neighbours,n=0;n<i.length;n++)if(t=this.graph.vertices[i[n]],h.default.containsAll(t.value.rings,e.value.rings))return t;return null}},{key:"isPointInRing",value:function(e){for(var t,i=0;i<this.rings.length;i++)if(t=this.rings[i],t.positioned){var n=l.default.polyCircumradius(this.opts.bondLength,t.getSize());if(e.distanceSq(t.center)<n*n)return!0}return!1}},{key:"isEdgeInRing",value:function(e){var t=this.graph.vertices[e.sourceId],i=this.graph.vertices[e.targetId];return this.areVerticesInSameRing(t,i)}},{key:"isEdgeRotatable",value:function(e){var t=this.graph.vertices[e.sourceId],i=this.graph.vertices[e.targetId];return!("-"!==e.bondType||t.isTerminal()||i.isTerminal()||0<t.value.rings.length&&0<i.value.rings.length&&this.areVerticesInSameRing(t,i))}},{key:"isRingAromatic",value:function(e){for(var t,i=0;i<e.members.length;i++)if(t=this.graph.vertices[e.members[i]],!t.value.isPartOfAromaticRing)return!1;return!0}},{key:"getEdgeNormals",value:function(e){var t=this.graph.vertices[e.sourceId].position,i=this.graph.vertices[e.targetId].position;return c.default.units(t,i)}},{key:"getBondCount",value:function(e){for(var t=0,i=0;i<e.edges.length;i++)t+=this.graph.edges[e.edges[i]].weight;return t}},{key:"getNonRingNeighbours",value:function(e){for(var t=[],i=this.graph.vertices[e],n=i.neighbours,r=0;r<n.length;r++){var o=this.graph.vertices[n[r]];0===h.default.intersection(i.value.rings,o.value.rings).length&&0==o.value.isBridge&&t.push(o)}return t}},{key:"annotateStereochemistry",value:function(){for(var e,t=0;t<this.graph.vertices.length;t++)if(e=this.graph.vertices[t],e.value.isStereoCenter){for(var i=e.getNeighbours(),n=i.length,r=Array(n),o=0;o<n;o++){var a=new Uint8Array(this.graph.vertices.length),s=[[]];a[e.id]=1,this.visitStereochemistry(i[o],e.id,a,s,10,0);for(var h=0;h<s.length;h++)s[h].sort(function(e,t){return t-e});r[o]=[o,s]}var c=0,u=0;for(o=0;o<r.length;o++){r[o][1].length>c&&(c=r[o][1].length);for(h=0;h<r[o][1].length;h++)r[o][1][h].length>u&&(u=r[o][1][h].length)}var d;for(o=0;o<r.length;o++){d=c-r[o][1].length;for(h=0;h<d;h++)r[o][1].push([]);r[o][1].push([i[o]]);var g;for(h=0;h<r[o][1].length;h++){g=u-r[o][1][h].length;for(var p=0;p<g;p++)r[o][1][h].push(0)}}r.sort(function(e,t){for(var i=0;i<e[1].length;i++)for(var n=0;n<e[1][i].length;n++){if(e[1][i][n]>t[1][i][n])return-1;if(e[1][i][n]<t[1][i][n])return 1}return 0});var f=new Uint8Array(n);for(o=0;o<n;o++)f[o]=r[o][0],e.value.priority=o;var v=this.graph.vertices[i[f[0]]].position,_=this.graph.vertices[i[f[1]]].position,y=this.graph.vertices[i[f[2]]].position,m=v.relativeClockwise(_,e.position),b=(v.relativeClockwise(y,e.position),-1===m),x="@"===e.value.bracket.chirality?-1:1,w=1==l.default.parityOfPermutation(f)*x?"R":"S",k="down",S="up";(b&&"R"!=w||!b&&"S"!=w)&&(e.value.hydrogenDirection="up",k="up",S="down"),e.value.hasHydrogen&&(this.graph.getEdge(e.id,i[f[f.length-1]]).wedge=k);var C=Array(i.length-1),A=1<e.value.rings.length&&e.value.hasHydrogen,R=e.value.hasHydrogen?1:0;for(o=0;o<f.length-R;o++){C[o]=new Uint32Array(2);var T=this.graph.vertices[i[f[o]]];C[o][0]+=T.value.isStereoCenter?0:1e5,C[o][0]+=this.areVerticesInSameRing(T,e)?0:1e4,C[o][0]+=T.value.isHeteroAtom()?1e3:0,C[o][0]-=0===T.value.subtreeDepth?1e3:0,C[o][0]+=1e3-T.value.subtreeDepth,C[o][1]=i[f[o]]}if(C.sort(function(e,t){return e[0]>t[0]?-1:e[0]<t[0]?1:0}),!A){var z=C[0][1];if(e.value.hasHydrogen)this.graph.getEdge(e.id,z).wedge=S;else{var P=S;for(o=f.length-1;0<=o&&(P=P==k?S:k,i[f[o]]!==z);o--);this.graph.getEdge(e.id,z).wedge=P}}e.value.chirality=w}}},{key:"visitStereochemistry",value:function(e,t,i,n,r,o){var a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0;i[e]=1;var s=this.graph.vertices[e],l=s.value.getAtomicNumber();n.length<=o&&n.push([]);for(var h=0;h<this.graph.getEdge(e,t).weight;h++)n[o].push(1e3*a+l);var c=this.graph.vertices[e].neighbours;for(h=0;h<c.length;h++)1!==i[c[h]]&&o<r-1&&this.visitStereochemistry(c[h],e,i.slice(),n,r,o+1,l);if(o<r-1){var u=0;for(h=0;h<c.length;h++)u+=this.graph.getEdge(e,c[h]).weight;for(h=0;h<s.value.getMaxBonds()-u;h++)n.length<=o+1&&n.push([]),n[o+1].push(1e3*l+1)}}},{key:"initPseudoElements",value:function(){for(var e=0;e<this.graph.vertices.length;e++){for(var t=this.graph.vertices[e],i=t.neighbours,n=Array(i.length),r=0;r<i.length;r++)n[r]=this.graph.vertices[i[r]];if(!(3>t.getNeighbourCount()||0<t.value.rings.length||"P"===t.value.element||"C"===t.value.element&&3===n.length&&"N"===n[0].value.element&&"N"===n[1].value.element&&"N"===n[2].value.element)){var o=0,a=0;for(r=0;r<n.length;r++){var s=n[r],l=s.value.element,h=s.getNeighbourCount();"C"!==l&&"H"!==l&&1===h&&o++,1<h&&a++}if(!(1<a||2>o)){var c,u=null;for(r=0;r<n.length;r++)c=n[r],1<c.getNeighbourCount()&&(u=c);var d;for(r=0;r<n.length;r++)if(d=n[r],!(1<d.getNeighbourCount())){d.value.isDrawn=!1;var p=g.default.maxBonds[d.value.element]-this.getBondCount(d),f="";d.value.bracket&&(p=d.value.bracket.hcount,f=d.value.bracket.charge||0),t.value.attachPseudoElement(d.value.element,u?u.value.element:null,p,f)}}}}for(e=0;e<this.graph.vertices.length;e++){var v=this.graph.vertices[e],_=v.value,y=_.element;if("C"!==y&&"H"!==y&&_.isDrawn){var m=v.neighbours,b=Array(m.length);for(r=0;r<m.length;r++)b[r]=this.graph.vertices[m[r]];var x;for(r=0;r<b.length;r++)if(x=b[r].value,x.hasAttachedPseudoElements&&2===x.getAttachedPseudoElementsCount()){var w=x.getAttachedPseudoElements();w.hasOwnProperty("0O")&&w.hasOwnProperty("3C")&&(x.isDrawn=!1,v.value.attachPseudoElement("Ac","",0))}}}}}]),e}();i.default=m},{"./ArrayHelper":2,"./Atom":3,"./CanvasWrapper":4,"./Edge":6,"./Graph":7,"./Line":8,"./MathHelper":9,"./Ring":11,"./RingConnection":12,"./SSSR":13,"./Vector2":14,"./Vertex":15}],6:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(){function e(t,i){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.id=null,this.sourceId=t,this.targetId=i,this.weight=n,this.bondType="-",this.isPartOfAromaticRing=!1,this.center=!1,this.wedge=""}return n(e,[{key:"setBondType",value:function(t){this.bondType=t,this.weight=e.bonds[t]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),e}();i.default=r},{}],7:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var r=Math.pow,o=Math.sqrt,a=Math.min;Object.defineProperty(i,"__esModule",{value:!0});var s=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i,n=[],r=!0,o=!1;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),h=n(e("./MathHelper")),c=(n(e("./Vector2")),n(e("./Vertex"))),u=n(e("./Edge")),d=(n(e("./Ring")),n(e("./Atom"))),g=function(){function e(t){var i=1<arguments.length&&void 0!==arguments[1]&&arguments[1];(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.vertices=[],this.edges=[],this.vertexIdsToEdgeId={},this.elementCount={},this.isomeric=i,this._time=0,this._init(t),this._initInfos()}return l(e,[{key:"_init",value:function(e){1<arguments.length&&void 0!==arguments[1]&&arguments[1];var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]&&arguments[3],n=new d.default(e.atom.element?e.atom.element:e.atom,e.bond);n.branchBond=e.branchBond,n.ringbonds=e.ringbonds,n.bracket=e.atom.element?e.atom:null;var r=new c.default(n),o=this.vertices[t];if(this.addVertex(r),null!==t){r.setParentVertexId(t),r.value.addNeighbouringElement(o.value.element),o.addChild(r.id),o.value.addNeighbouringElement(n.element),o.spanningTreeChildren.push(r.id);var a=new u.default(t,r.id,1);i?(a.setBondType(r.value.branchBond||"-"),r.id):(a.setBondType(o.value.bondType||"-"),o.id);var s=this.addEdge(a);r.edges.push(s),o.edges.push(s)}var l=e.ringbondCount+1;n.bracket&&(l+=n.bracket.hcount);var h=0;if(n.bracket&&n.bracket.chirality){n.isStereoCenter=!0,h=n.bracket.hcount;for(var g=0;g<h;g++)this._init({atom:"H",isBracket:"false",branches:[],branchCount:0,ringbonds:[],ringbondCount:!1,next:null,hasNext:!1,bond:"-"},g,r.id,!0)}for(g=0;g<e.branchCount;g++)this._init(e.branches[g],g+l,r.id,!0);e.hasNext&&this._init(e.next,e.branchCount+l,r.id)}},{key:"_initInfos",value:function(){for(var e,t=0;t<this.vertices.length;t++)e=this.vertices[t].value,void 0===this.elementCount[e.element]?this.elementCount[e.element]=0:this.elementCount[e.element]+=1}},{key:"clear",value:function(){this.vertices=[],this.edges=[],this.vertexIdsToEdgeId={}}},{key:"addVertex",value:function(e){return e.id=this.vertices.length,this.vertices.push(e),e.id}},{key:"addEdge",value:function(e){return e.id=this.edges.length,this.edges.push(e),this.vertexIdsToEdgeId[e.sourceId+"_"+e.targetId]=e.id,this.vertexIdsToEdgeId[e.targetId+"_"+e.sourceId]=e.id,e.isPartOfAromaticRing=this.vertices[e.sourceId].value.isPartOfAromaticRing&&this.vertices[e.targetId].value.isPartOfAromaticRing,e.id}},{key:"getEdge",value:function(e,t){var i=this.vertexIdsToEdgeId[e+"_"+t];return void 0===i?null:this.edges[i]}},{key:"getEdges",value:function(e){for(var t=[],i=this.vertices[e],n=0;n<i.neighbours.length;n++)t.push(this.vertexIdsToEdgeId[e+"_"+i.neighbours[n]]);return t}},{key:"hasEdge",value:function(e,t){return void 0!==this.vertexIdsToEdgeId[e+"_"+t]}},{key:"getVertexList",value:function(){for(var e=[this.vertices.length],t=0;t<this.vertices.length;t++)e[t]=this.vertices[t].id;return e}},{key:"getEdgeList",value:function(){for(var e=Array(this.edges.length),t=0;t<this.edges.length;t++)e[t]=[this.edges[t].sourceId,this.edges[t].targetId];return e}},{key:"getAdjacencyMatrix",value:function(){for(var e=this.vertices.length,t=Array(e),i=0;i<e;i++)t[i]=Array(e),t[i].fill(0);var n;for(i=0;i<this.edges.length;i++)n=this.edges[i],t[n.sourceId][n.targetId]=1,t[n.targetId][n.sourceId]=1;return t}},{key:"getComponentsAdjacencyMatrix",value:function(){for(var e=this.vertices.length,t=Array(e),i=this.getBridges(),n=0;n<e;n++)t[n]=Array(e),t[n].fill(0);var r;for(n=0;n<this.edges.length;n++)r=this.edges[n],t[r.sourceId][r.targetId]=1,t[r.targetId][r.sourceId]=1;for(n=0;n<i.length;n++)t[i[n][0]][i[n][1]]=0,t[i[n][1]][i[n][0]]=0;return t}},{key:"getSubgraphAdjacencyMatrix",value:function(e){for(var t=e.length,i=Array(t),n=0;n<t;n++){i[n]=Array(t),i[n].fill(0);for(var r=0;r<t;r++)n!==r&&this.hasEdge(e[n],e[r])&&(i[n][r]=1)}return i}},{key:"getDistanceMatrix",value:function(){for(var e=this.vertices.length,t=this.getAdjacencyMatrix(),i=Array(e),n=0;n<e;n++)i[n]=Array(e),i[n].fill(1/0);for(n=0;n<e;n++)for(var r=0;r<e;r++)1===t[n][r]&&(i[n][r]=1);for(var o=0;o<e;o++)for(n=0;n<e;n++)for(r=0;r<e;r++)i[n][r]>i[n][o]+i[o][r]&&(i[n][r]=i[n][o]+i[o][r]);return i}},{key:"getSubgraphDistanceMatrix",value:function(e){for(var t=e.length,i=this.getSubgraphAdjacencyMatrix(e),n=Array(t),r=0;r<t;r++)n[r]=Array(t),n[r].fill(1/0);for(r=0;r<t;r++)for(var o=0;o<t;o++)1===i[r][o]&&(n[r][o]=1);for(var a=0;a<t;a++)for(r=0;r<t;r++)for(o=0;o<t;o++)n[r][o]>n[r][a]+n[a][o]&&(n[r][o]=n[r][a]+n[a][o]);return n}},{key:"getAdjacencyList",value:function(){for(var e=this.vertices.length,t=Array(e),i=0;i<e;i++){t[i]=[];for(var n=0;n<e;n++)i!==n&&this.hasEdge(this.vertices[i].id,this.vertices[n].id)&&t[i].push(n)}return t}},{key:"getSubgraphAdjacencyList",value:function(e){for(var t=e.length,i=Array(t),n=0;n<t;n++){i[n]=[];for(var r=0;r<t;r++)n!==r&&this.hasEdge(e[n],e[r])&&i[n].push(r)}return i}},{key:"getBridges",value:function(){var e=this.vertices.length,t=Array(e),i=Array(e),n=Array(e),r=Array(e),o=this.getAdjacencyList(),a=[];t.fill(!1),r.fill(null),this._time=0;for(var s=0;s<e;s++)t[s]||this._bridgeDfs(s,t,i,n,r,o,a);return a}},{key:"traverseBF",value:function(e,t){var i=this.vertices.length,n=Array(i);n.fill(!1);for(var r=[e];0<r.length;){var o=r.shift(),a=this.vertices[o];t(a);for(var s,l=0;l<a.neighbours.length;l++)s=a.neighbours[l],n[s]||(n[s]=!0,r.push(s))}}},{key:"getTreeDepth",value:function(e,t){if(null===e||null===t)return 0;for(var i=this.vertices[e].getSpanningTreeNeighbours(t),n=0,r=0;r<i.length;r++){var o=i[r],a=this.getTreeDepth(o,e);a>n&&(n=a)}return n+1}},{key:"traverseTree",value:function(e,t,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:Number.MAX_SAFE_INTEGER,r=4<arguments.length&&void 0!==arguments[4]&&arguments[4],o=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null;if(null===a&&(a=new Uint8Array(this.vertices.length)),!(o>n+1||1===a[e])){a[e]=1;var s=this.vertices[e],l=s.getNeighbours(t);(!r||1<o)&&i(s);for(var h=0;h<l.length;h++)this.traverseTree(l[h],e,i,n,r,o+1,a)}}},{key:"kkLayout",value:function(e,t,i,n,a){for(var l=a,c=e.length;c--;)var u=this.vertices[e[c]],d=u.neighbours.length;var g=this.getSubgraphDistanceMatrix(e),p=e.length,f=h.default.polyCircumradius(500,p),v=h.default.centralAngle(p),_=0,y=new Float32Array(p),m=new Float32Array(p),b=Array(p);for(c=p;c--;){var x=this.vertices[e[c]];x.positioned?(y[c]=x.position.x,m[c]=x.position.y):(y[c]=t.x+Math.cos(_)*f,m[c]=t.y+Math.sin(_)*f),b[c]=x.positioned,_+=v}var w=Array(p);for(c=p;c--;){w[c]=Array(p);for(d=p;d--;)w[c][d]=a*g[c][d]}var k=Array(p);for(c=p;c--;){k[c]=Array(p);for(d=p;d--;)k[c][d]=l*r(g[c][d],-2)}var S,C,A,R,T,z,P,L=Array(p),B=new Float32Array(p),I=new Float32Array(p);for(c=p;c--;)L[c]=Array(p);for(c=p;c--;){S=y[c],C=m[c],A=0,R=0;for(var O=p;O--;)c!==O&&(T=y[O],z=m[O],P=1/o((S-T)*(S-T)+(C-z)*(C-z)),L[c][O]=[k[c][O]*(S-T-w[c][O]*(S-T)*P),k[c][O]*(C-z-w[c][O]*(C-z)*P)],L[O][c]=L[c][O],A+=L[c][O][0],R+=L[c][O][1]);B[c]=A,I[c]=R}for(var D=function(e){return[B[e]*B[e]+I[e]*I[e],B[e],I[e]]},E=function(){var e=0,t=0,i=0,n=0;for(c=p;c--;){var r=D(c),o=s(r,3),a=o[0],l=o[1],h=o[2];a>e&&!1===b[c]&&(e=a,t=c,i=l,n=h)}return[t,e,i,n]},N=function(e,t,i){var n=0,a=0,s=0,l=y[e],h=m[e],u=w[e],d=k[e];for(c=p;c--;)if(c!==e){var g=y[c],f=m[c],v=u[c],_=d[c],b=(l-g)*(l-g),x=1/r(b+(h-f)*(h-f),1.5);n+=_*(1-v*(h-f)*(h-f)*x),a+=_*(1-v*b*x),s+=_*(v*(l-g)*(h-f)*x)}0==n&&(n=.1),0==a&&(a=.1),0==s&&(s=.1);var S=t/n+i/s,C=-(s*(S/=s/n-a/s)+t)/n;y[e]+=C,m[e]+=S;var A,R,T,z,P,O=L[e];for(t=0,i=0,l=y[e],h=m[e],c=p;c--;)e!==c&&(A=y[c],R=m[c],T=O[c][0],z=O[c][1],P=1/o((l-A)*(l-A)+(h-R)*(h-R)),C=d[c]*(l-A-u[c]*(l-A)*P),S=d[c]*(h-R-u[c]*(h-R)*P),O[c]=[C,S],t+=C,i+=S,B[c]+=C-T,I[c]+=S-z);B[e]=t,I[e]=i},j=1e9,M=0,F=0,V=0,H=0,W=0,K=0;j>.1&&2e3>W;){W++;var q=E(),U=s(q,4);for(M=U[0],j=U[1],F=U[2],V=U[3],H=j,K=0;H>.1&&50>K;){K++,N(M,F,V);var G=D(M),Y=s(G,3);H=Y[0],F=Y[1],V=Y[2]}}for(c=p;c--;){var X=e[c],Z=this.vertices[X];Z.position.x=y[c],Z.position.y=m[c],Z.positioned=!0,Z.forcePositioned=!0}}},{key:"_bridgeDfs",value:function(e,t,i,n,r,o,s){t[e]=!0,i[e]=n[e]=++this._time;for(var l,h=0;h<o[e].length;h++)l=o[e][h],t[l]?l!==r[e]&&(n[e]=a(n[e],i[l])):(r[l]=e,this._bridgeDfs(l,t,i,n,r,o,s),n[e]=a(n[e],n[l]),n[l]>i[e]&&s.push([e,l]))}}],[{key:"getConnectedComponents",value:function(t){var i=t.length,n=Array(i),r=[];n.fill(!1);for(var o=0;o<i;o++)if(!n[o]){var a=[];n[o]=!0,a.push(o),0,e._ccGetDfs(o,n,t,a),1<a.length&&r.push(a)}return r}},{key:"getConnectedComponentCount",value:function(t){var i=t.length,n=Array(i),r=0;n.fill(!1);for(var o=0;o<i;o++)n[o]||(n[o]=!0,r++,e._ccCountDfs(o,n,t));return r}},{key:"_ccCountDfs",value:function(t,i,n){for(var r,o=0;o<n[t].length;o++)r=n[t][o],r&&!i[o]&&t!==o&&(i[o]=!0,e._ccCountDfs(o,i,n))}},{key:"_ccGetDfs",value:function(t,i,n,r){for(var o,a=0;a<n[t].length;a++)o=n[t][a],o&&!i[a]&&t!==a&&(i[a]=!0,r.push(a),e._ccGetDfs(a,i,n,r))}}]),e}();i.default=g},{"./Atom":3,"./Edge":6,"./MathHelper":9,"./Ring":11,"./Vector2":14,"./Vertex":15}],8:[function(e,t,i){"use strict";var n=Math.pow;Object.defineProperty(i,"__esModule",{value:!0});var r,o=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=e("./Vector2"),s=(r=a)&&r.__esModule?r:{default:r},l=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new s.default(0,0),i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new s.default(0,0),n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,o=4<arguments.length&&void 0!==arguments[4]&&arguments[4],a=5<arguments.length&&void 0!==arguments[5]&&arguments[5];(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.from=t,this.to=i,this.elementFrom=n,this.elementTo=r,this.chiralFrom=o,this.chiralTo=a}return o(e,[{key:"clone",value:function(){return new e(this.from.clone(),this.to.clone(),this.elementFrom,this.elementTo)}},{key:"getLength",value:function(){return Math.sqrt(n(this.to.x-this.from.x,2)+n(this.to.y-this.from.y,2))}},{key:"getAngle",value:function(){return s.default.subtract(this.getRightVector(),this.getLeftVector()).angle()}},{key:"getRightVector",value:function(){return this.from.x<this.to.x?this.to:this.from}},{key:"getLeftVector",value:function(){return this.from.x<this.to.x?this.from:this.to}},{key:"getRightElement",value:function(){return this.from.x<this.to.x?this.elementTo:this.elementFrom}},{key:"getLeftElement",value:function(){return this.from.x<this.to.x?this.elementFrom:this.elementTo}},{key:"getRightChiral",value:function(){return this.from.x<this.to.x?this.chiralTo:this.chiralFrom}},{key:"getLeftChiral",value:function(){return this.from.x<this.to.x?this.chiralFrom:this.chiralTo}},{key:"setRightVector",value:function(e,t){return this.from.x<this.to.x?(this.to.x=e,this.to.y=t):(this.from.x=e,this.from.y=t),this}},{key:"setLeftVector",value:function(e,t){return this.from.x<this.to.x?(this.from.x=e,this.from.y=t):(this.to.x=e,this.to.y=t),this}},{key:"rotateToXAxis",value:function(){var e=this.getLeftVector();return this.setRightVector(e.x+this.getLength(),e.y),this}},{key:"rotate",value:function(e){var t=this.getLeftVector(),i=this.getRightVector(),n=Math.sin(e),r=Math.cos(e),o=r*(i.x-t.x)-n*(i.y-t.y)+t.x,a=n*(i.x-t.x)-r*(i.y-t.y)+t.y;return this.setRightVector(o,a),this}},{key:"shortenFrom",value:function(e){var t=s.default.subtract(this.to,this.from);return t.normalize(),t.multiplyScalar(e),this.from.add(t),this}},{key:"shortenTo",value:function(e){var t=s.default.subtract(this.from,this.to);return t.normalize(),t.multiplyScalar(e),this.to.add(t),this}},{key:"shortenRight",value:function(e){return this.from.x<this.to.x?this.shortenTo(e):this.shortenFrom(e),this}},{key:"shortenLeft",value:function(e){return this.from.x<this.to.x?this.shortenFrom(e):this.shortenTo(e),this}},{key:"shorten",value:function(e){var t=s.default.subtract(this.from,this.to);return t.normalize(),t.multiplyScalar(e/2),this.to.add(t),this.from.subtract(t),this}}]),e}();i.default=l},{"./Vector2":14}],9:[function(e,t,i){"use strict";var n=Math.sin,r=Math.cos,o=Math.PI;Object.defineProperty(i,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return a(e,null,[{key:"round",value:function(e,t){return t=t||1,+(Math.round(e+"e"+t)+"e-"+t)}},{key:"meanAngle",value:function(e){for(var t=0,i=0,o=0;o<e.length;o++)t+=n(e[o]),i+=r(e[o]);return Math.atan2(t/e.length,i/e.length)}},{key:"innerAngle",value:function(t){return e.toRad(180*(t-2)/t)}},{key:"polyCircumradius",value:function(e,t){return e/(2*n(o/t))}},{key:"apothem",value:function(e,t){return e*r(o/t)}},{key:"apothemFromSideLength",value:function(t,i){var n=e.polyCircumradius(t,i);return e.apothem(n,i)}},{key:"centralAngle",value:function(t){return e.toRad(360/t)}},{key:"toDeg",value:function(t){return t*e.degFactor}},{key:"toRad",value:function(t){return t*e.radFactor}},{key:"parityOfPermutation",value:function(e){for(var t=new Uint8Array(e.length),i=0,n=function i(n){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return 1===t[n]?r:(r++,t[n]=1,i(e[n],r))},r=0;r<e.length;r++)if(1!==t[r]){i+=1-n(r)%2}return i%2?-1:1}},{key:"radFactor",get:function(){return o/180}},{key:"degFactor",get:function(){return 180/o}},{key:"twoPI",get:function(){return 2*o}}]),e}();i.default=s},{}],10:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.default=function(){function e(t,i,n,r){this.message=t,this.expected=i,this.found=n,this.location=r,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}return function(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}(e,Error),{SyntaxError:e,parse:function(t){function i(e){var i,n,r=Ue[e];if(r)return r;for(i=e-1;!Ue[i];)i--;for(r={line:(r=Ue[i]).line,column:r.column,seenCR:r.seenCR};i<e;)n=t.charAt(i),"\n"===n?(!r.seenCR&&r.line++,r.column=1,r.seenCR=!1):"\r"===n||"\u2028"===n||"\u2029"===n?(r.line++,r.column=1,r.seenCR=!0):(r.column++,r.seenCR=!1),i++;return Ue[e]=r,r}function n(e,t){var n=i(e),r=i(t);return{start:{offset:e,line:n.line,column:n.column},end:{offset:t,line:r.line,column:r.column}}}function r(e){qe<Ge||(qe>Ge&&(Ge=qe,Ye=[]),Ye.push(e))}function o(){var e,i,n,u,d,g,p,f,_,y,b,x,w,k,S,A,R,T,X,Z,$,J,Q,oe,ae,ue,Ue,Ge,Ye,Xe,Ze,$e,Je,Qe,et,tt,it,nt,rt,ot,at,st,lt,ht,ct,ut,dt,gt,pt,ft,vt,_t,yt,mt,bt,xt,wt,kt,St,Ct;if(e=qe,i=qe,b=qe,wt=qe,kt=qe,66===t.charCodeAt(qe)?(St=j,qe++):(St=v,r(M)),St===v?(qe=kt,kt=v):(114===t.charCodeAt(qe)?(Ct=F,qe++):(Ct=v,r(V)),Ct===v&&(Ct=null),Ct===v?(qe=kt,kt=v):kt=St=[St,Ct]),kt===v&&(kt=qe,67===t.charCodeAt(qe)?(St=H,qe++):(St=v,r(W)),St===v?(qe=kt,kt=v):(108===t.charCodeAt(qe)?(Ct=K,qe++):(Ct=v,r(q)),Ct===v&&(Ct=null),Ct===v?(qe=kt,kt=v):kt=St=[St,Ct]),kt===v&&(U.test(t.charAt(qe))?(kt=t.charAt(qe),qe++):(kt=v,r(G)))),kt!==v&&(wt,kt=Y(kt)),(x=wt=kt)===v&&(x=l())===v&&(w=qe,k=qe,91===t.charCodeAt(qe)?(S=z,qe++):(S=v,r(P)),S===v?(qe=k,k=v):(_t=qe,yt=qe,se.test(t.charAt(qe))?(mt=t.charAt(qe),qe++):(mt=v,r(le)),mt===v?(qe=yt,yt=v):(he.test(t.charAt(qe))?(bt=t.charAt(qe),qe++):(bt=v,r(ce)),bt===v&&(bt=null),bt===v?(qe=yt,yt=v):(he.test(t.charAt(qe))?(xt=t.charAt(qe),qe++):(xt=v,r(ce)),xt===v&&(xt=null),xt===v?(qe=yt,yt=v):yt=mt=[mt,bt,xt])),yt!==v&&(_t,yt=Ke(yt)),(A=_t=yt)===v&&(A=null),A===v?(qe=k,k=v):(t.substr(qe,2)===L?(R=L,qe+=2):(R=v,r(B)),R===v&&(t.substr(qe,2)===I?(R=I,qe+=2):(R=v,r(O)),R===v&&(R=l())===v&&(gt=qe,pt=qe,ee.test(t.charAt(qe))?(ft=t.charAt(qe),qe++):(ft=v,r(te)),ft===v?(qe=pt,pt=v):(ie.test(t.charAt(qe))?(vt=t.charAt(qe),qe++):(vt=v,r(ne)),vt===v&&(vt=null),vt===v?(qe=pt,pt=v):pt=ft=[ft,vt]),pt!==v&&(gt,pt=re(pt)),(R=gt=pt)===v&&(R=h()))),R===v?(qe=k,k=v):(at=qe,st=qe,64===t.charCodeAt(qe)?(lt=de,qe++):(lt=v,r(ge)),lt===v?(qe=st,st=v):(64===t.charCodeAt(qe)?(ht=de,qe++):(ht=v,r(ge)),ht===v&&(ht=qe,t.substr(qe,2)===pe?(ct=pe,qe+=2):(ct=v,r(fe)),ct===v?(qe=ht,ht=v):(ve.test(t.charAt(qe))?(ut=t.charAt(qe),qe++):(ut=v,r(_e)),ut===v?(qe=ht,ht=v):ht=ct=[ct,ut]),ht===v&&(ht=qe,t.substr(qe,2)===ye?(ct=ye,qe+=2):(ct=v,r(me)),ct===v?(qe=ht,ht=v):(ve.test(t.charAt(qe))?(ut=t.charAt(qe),qe++):(ut=v,r(_e)),ut===v?(qe=ht,ht=v):ht=ct=[ct,ut]),ht===v&&(ht=qe,t.substr(qe,2)===be?(ct=be,qe+=2):(ct=v,r(xe)),ct===v?(qe=ht,ht=v):(we.test(t.charAt(qe))?(ut=t.charAt(qe),qe++):(ut=v,r(ke)),ut===v?(qe=ht,ht=v):ht=ct=[ct,ut]),ht===v&&(ht=qe,t.substr(qe,2)===Se?(ct=Se,qe+=2):(ct=v,r(Ce)),ct===v?(qe=ht,ht=v):(se.test(t.charAt(qe))?(ut=t.charAt(qe),qe++):(ut=v,r(le)),ut===v?(qe=ht,ht=v):(he.test(t.charAt(qe))?(dt=t.charAt(qe),qe++):(dt=v,r(ce)),dt===v&&(dt=null),dt===v?(qe=ht,ht=v):ht=ct=[ct,ut,dt])),ht===v&&(ht=qe,t.substr(qe,2)===Ae?(ct=Ae,qe+=2):(ct=v,r(Re)),ct===v?(qe=ht,ht=v):(se.test(t.charAt(qe))?(ut=t.charAt(qe),qe++):(ut=v,r(le)),ut===v?(qe=ht,ht=v):(he.test(t.charAt(qe))?(dt=t.charAt(qe),qe++):(dt=v,r(ce)),dt===v&&(dt=null),dt===v?(qe=ht,ht=v):ht=ct=[ct,ut,dt]))))))),ht===v&&(ht=null),ht===v?(qe=st,st=v):st=lt=[lt,ht]),st!==v&&(at,st=Te(st)),(T=at=st)===v&&(T=null),T===v?(qe=k,k=v):(it=qe,nt=qe,72===t.charCodeAt(qe)?(rt=Ee,qe++):(rt=v,r(Ne)),rt===v?(qe=nt,nt=v):(he.test(t.charAt(qe))?(ot=t.charAt(qe),qe++):(ot=v,r(ce)),ot===v&&(ot=null),ot===v?(qe=nt,nt=v):nt=rt=[rt,ot]),nt!==v&&(it,nt=je(nt)),(X=it=nt)===v&&(X=null),X===v?(qe=k,k=v):(Q=qe,Ze=qe,$e=qe,43===t.charCodeAt(qe)?(Je=Pe,qe++):(Je=v,r(Le)),Je===v?(qe=$e,$e=v):(43===t.charCodeAt(qe)?(Qe=Pe,qe++):(Qe=v,r(Le)),Qe===v&&(Qe=qe,se.test(t.charAt(qe))?(et=t.charAt(qe),qe++):(et=v,r(le)),et===v?(qe=Qe,Qe=v):(he.test(t.charAt(qe))?(tt=t.charAt(qe),qe++):(tt=v,r(ce)),tt===v&&(tt=null),tt===v?(qe=Qe,Qe=v):Qe=et=[et,tt])),Qe===v&&(Qe=null),Qe===v?(qe=$e,$e=v):$e=Je=[Je,Qe]),$e!==v&&(Ze,$e=Be($e)),(oe=Ze=$e)===v&&(ae=qe,ue=qe,45===t.charCodeAt(qe)?(Ue=Ie,qe++):(Ue=v,r(Oe)),Ue===v?(qe=ue,ue=v):(45===t.charCodeAt(qe)?(Ge=Ie,qe++):(Ge=v,r(Oe)),Ge===v&&(Ge=qe,se.test(t.charAt(qe))?(Ye=t.charAt(qe),qe++):(Ye=v,r(le)),Ye===v?(qe=Ge,Ge=v):(he.test(t.charAt(qe))?(Xe=t.charAt(qe),qe++):(Xe=v,r(ce)),Xe===v&&(Xe=null),Xe===v?(qe=Ge,Ge=v):Ge=Ye=[Ye,Xe])),Ge===v&&(Ge=null),Ge===v?(qe=ue,ue=v):ue=Ue=[Ue,Ge]),ue!==v&&(ae,ue=De(ue)),oe=ae=ue),oe!==v&&(Q,oe=ze(oe)),(Z=Q=oe)===v&&(Z=null),Z===v?(qe=k,k=v):(($=function(){var e,i,n,o,a,s,l;if(e=qe,i=qe,58===t.charCodeAt(qe)?(n=Me,qe++):(n=v,r(Fe)),n!==v){if(o=qe,se.test(t.charAt(qe))?(a=t.charAt(qe),qe++):(a=v,r(le)),a!==v){for(s=[],he.test(t.charAt(qe))?(l=t.charAt(qe),qe++):(l=v,r(ce));l!==v;)s.push(l),he.test(t.charAt(qe))?(l=t.charAt(qe),qe++):(l=v,r(ce));s===v?(qe=o,o=v):o=a=[a,s]}else qe=o,o=v;o===v&&(Ve.test(t.charAt(qe))?(o=t.charAt(qe),qe++):(o=v,r(He))),o===v?(qe=i,i=v):i=n=[n,o]}else qe=i,i=v;return i!==v&&(e,i=We(i)),e=i}())===v&&($=null),$===v?(qe=k,k=v):(93===t.charCodeAt(qe)?(J=D,qe++):(J=v,r(E)),J===v?(qe=k,k=v):k=S=[S,A,R,T,X,Z,$,J]))))))),k!==v&&(w,k=N(k)),(x=w=k)===v&&(x=h())),x!==v&&(b,x=C(x)),(n=b=x)!==v){for(u=[],d=a();d!==v;)u.push(d),d=a();if(u!==v){for(d=[],g=qe,(p=s())===v&&(p=null),p===v?(qe=g,g=v):(f=c())===v?(qe=g,g=v):g=p=[p,f];g!==v;)d.push(g),g=qe,p=s(),p===v&&(p=null),p===v?(qe=g,g=v):(f=c(),f===v?(qe=g,g=v):(p=[p,f],g=p));if(d!==v){for(g=[],p=a();p!==v;)g.push(p),p=a();if(g===v)qe=i,i=v;else if(p=s(),p===v&&(p=null),p===v)qe=i,i=v;else if(f=o(),f===v&&(f=null),f!==v){for(_=[],y=a();y!==v;)_.push(y),y=a();_===v?(qe=i,i=v):i=n=[n,u,d,g,p,f,_]}else qe=i,i=v}else qe=i,i=v}else qe=i,i=v}else qe=i,i=v;return i!==v&&(e,i=m(i)),e=i}function a(){var e,i,n,a,l,h;return e=qe,i=qe,40===t.charCodeAt(qe)?(n=b,qe++):(n=v,r(x)),n===v?(qe=i,i=v):((a=s())===v&&(a=null),a===v?(qe=i,i=v):(l=o())===v?(qe=i,i=v):(41===t.charCodeAt(qe)?(h=w,qe++):(h=v,r(k)),h===v?(qe=i,i=v):i=n=[n,a,l,h])),i!==v&&(e,i=S(i)),e=i}function s(){var e,i;return e=qe,A.test(t.charAt(qe))?(i=t.charAt(qe),qe++):(i=v,r(R)),i!==v&&(e,i=T(i)),e=i}function l(){var e,i;return e=qe,X.test(t.charAt(qe))?(i=t.charAt(qe),qe++):(i=v,r(Z)),i!==v&&(e,i=C(i)),e=i}function h(){var e,i;return e=qe,42===t.charCodeAt(qe)?(i=$,qe++):(i=v,r(J)),i!==v&&(e,i=Q(i)),e=i}function c(){var e,i,n,o,a;return e=qe,i=qe,37===t.charCodeAt(qe)?(n=oe,qe++):(n=v,r(ae)),n===v?(qe=i,i=v):(se.test(t.charAt(qe))?(o=t.charAt(qe),qe++):(o=v,r(le)),o===v?(qe=i,i=v):(he.test(t.charAt(qe))?(a=t.charAt(qe),qe++):(a=v,r(ce)),a===v?(qe=i,i=v):i=n=[n,o,a])),i===v&&(he.test(t.charAt(qe))?(i=t.charAt(qe),qe++):(i=v,r(ce))),i!==v&&(e,i=ue(i)),e=i}var u,d,g,p,f=1<arguments.length?arguments[1]:{},v={},_={chain:o},y=o,m=function(e){for(var t=[],i=[],n=0;n<e[1].length;n++)t.push(e[1][n]);var r;for(n=0;n<e[2].length;n++)r=e[2][n][0]?e[2][n][0]:"-",i.push({bond:r,id:e[2][n][1]});for(n=0;n<e[3].length;n++)t.push(e[3][n]);for(n=0;n<e[6].length;n++)t.push(e[6][n]);return{atom:e[0],isBracket:!!e[0].element,branches:t,branchCount:t.length,ringbonds:i,ringbondCount:i.length,bond:e[4]?e[4]:"-",next:e[5],hasNext:!!e[5]}},b="(",x={type:"literal",value:"(",description:'"("'},w=")",k={type:"literal",value:")",description:'")"'},S=function(e){var t=e[1]?e[1]:"-";return e[2].branchBond=t,e[2]},C=function(e){return e},A=/^[\-=#$:\/\\.]/,R={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},T=function(e){return e},z="[",P={type:"literal",value:"[",description:'"["'},L="se",B={type:"literal",value:"se",description:'"se"'},I="as",O={type:"literal",value:"as",description:'"as"'},D="]",E={type:"literal",value:"]",description:'"]"'},N=function(e){return{isotope:e[1],element:e[2],chirality:e[3],hcount:e[4],charge:e[5],class:e[6]}},j="B",M={type:"literal",value:"B",description:'"B"'},F="r",V={type:"literal",value:"r",description:'"r"'},H="C",W={type:"literal",value:"C",description:'"C"'},K="l",q={type:"literal",value:"l",description:'"l"'},U=/^[NOPSFI]/,G={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},Y=function(e){return 1<e.length?e.join(""):e},X=/^[bcnops]/,Z={type:"class",value:"[bcnops]",description:"[bcnops]"},$="*",J={type:"literal",value:"*",description:'"*"'},Q=function(e){return e},ee=/^[A-Z]/,te={type:"class",value:"[A-Z]",description:"[A-Z]"},ie=/^[a-z]/,ne={type:"class",value:"[a-z]",description:"[a-z]"},re=function(e){return e.join("")},oe="%",ae={type:"literal",value:"%",description:'"%"'},se=/^[1-9]/,le={type:"class",value:"[1-9]",description:"[1-9]"},he=/^[0-9]/,ce={type:"class",value:"[0-9]",description:"[0-9]"},ue=function(e){return 1==e.length?+e:+e.join("").replace("%","")},de="@",ge={type:"literal",value:"@",description:'"@"'},pe="TH",fe={type:"literal",value:"TH",description:'"TH"'},ve=/^[12]/,_e={type:"class",value:"[12]",description:"[12]"},ye="AL",me={type:"literal",value:"AL",description:'"AL"'},be="SP",xe={type:"literal",value:"SP",description:'"SP"'},we=/^[1-3]/,ke={type:"class",value:"[1-3]",description:"[1-3]"},Se="TB",Ce={type:"literal",value:"TB",description:'"TB"'},Ae="OH",Re={type:"literal",value:"OH",description:'"OH"'},Te=function(e){return e[1]?"@"==e[1]?"@@":e[1].join("").replace(",",""):"@"},ze=function(e){return e},Pe="+",Le={type:"literal",value:"+",description:'"+"'},Be=function(e){return e[1]?"+"==e[1]?2:+e[1].join(""):1},Ie="-",Oe={type:"literal",value:"-",description:'"-"'},De=function(e){return e[1]?"-"==e[1]?-2:-+e[1].join(""):-1},Ee="H",Ne={type:"literal",value:"H",description:'"H"'},je=function(e){return e[1]?+e[1]:1},Me=":",Fe={type:"literal",value:":",description:'":"'},Ve=/^[0]/,He={type:"class",value:"[0]",description:"[0]"},We=function(e){return+(e[1][0]+e[1][1].join(""))},Ke=function(e){return+e.join("")},qe=0,Ue=[{line:1,column:1,seenCR:!1}],Ge=0,Ye=[];if("startRule"in f){if(!(f.startRule in _))throw new Error("Can't start parsing from rule \""+f.startRule+'".');y=_[f.startRule]}if((u=y())!==v&&qe===t.length)return u;throw u!==v&&qe<t.length&&r({type:"end",description:"end of input"}),d=Ye,g=Ge<t.length?t.charAt(Ge):null,p=Ge<t.length?n(Ge,Ge+1):n(Ge,Ge),null!==d&&function(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}(d),new e(function(e,t){var i,n=Array(e.length);for(i=0;i<e.length;i++)n[i]=e[i].description;return"Expected "+(1<e.length?n.slice(0,-1).join(", ")+" or "+n[e.length-1]:n[0])+" but "+(t?'"'+function(e){function i(e){return e.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+i(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+i(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+i(e)})}()+'"':"end of input")+" found."}(d,g),d,g,p)}}}()},{}],11:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=n(e("./ArrayHelper")),a=n(e("./Vector2")),s=(n(e("./Vertex")),n(e("./RingConnection"))),l=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.id=null,this.members=t,this.edges=[],this.insiders=[],this.neighbours=[],this.positioned=!1,this.center=new a.default(0,0),this.rings=[],this.isBridged=!1,this.isPartOfBridged=!1,this.isSpiro=!1,this.isFused=!1,this.centralAngle=0,this.canFlip=!0}return r(e,[{key:"clone",value:function(){var t=new e(this.members);return t.id=this.id,t.insiders=o.default.clone(this.insiders),t.neighbours=o.default.clone(this.neighbours),t.positioned=this.positioned,t.center=this.center.clone(),t.rings=o.default.clone(this.rings),t.isBridged=this.isBridged,t.isPartOfBridged=this.isPartOfBridged,t.isSpiro=this.isSpiro,t.isFused=this.isFused,t.centralAngle=this.centralAngle,t.canFlip=this.canFlip,t}},{key:"getSize",value:function(){return this.members.length}},{key:"getPolygon",value:function(e){for(var t=[],i=0;i<this.members.length;i++)t.push(e[this.members[i]].position);return t}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(e,t,i,n){for(var r,o=i=i||0===i?i:this.members[0],a=0;null!=o&&100>a;)r=o,t(r),o=e[o].getNextInRing(e,this.id,n),n=r,o==i&&(o=null),a++}},{key:"getOrderedNeighbours",value:function(e){for(var t,i=Array(this.neighbours.length),n=0;n<this.neighbours.length;n++)t=s.default.getVertices(e,this.id,this.neighbours[n]),i[n]={n:t.length,neighbour:this.neighbours[n]};return i.sort(function(e,t){return t.n-e.n}),i}},{key:"isBenzeneLike",value:function(e){var t=this.getDoubleBondCount(e),i=this.members.length;return 3===t&&6===i||2===t&&5===i}},{key:"getDoubleBondCount",value:function(e){for(var t,i=0,n=0;n<this.members.length;n++)t=e[this.members[n]].value,("="===t.bondType||"="===t.branchBond)&&i++;return i}},{key:"contains",value:function(e){for(var t=0;t<this.members.length;t++)if(this.members[t]==e)return!0;return!1}}]),e}();i.default=l},{"./ArrayHelper":2,"./RingConnection":12,"./Vector2":14,"./Vertex":15}],12:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}Object.defineProperty(i,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=(n(e("./Vertex")),n(e("./Ring")),function(){function e(t,i){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.id=null,this.firstRingId=t.id,this.secondRingId=i.id,this.vertices=new Set;for(var n,r=0;r<t.members.length;r++){n=t.members[r];for(var o,a=0;a<i.members.length;a++)o=i.members[a],n===o&&this.addVertex(n)}}return o(e,[{key:"addVertex",value:function(e){this.vertices.add(e)}},{key:"updateOther",value:function(e,t){this.firstRingId===t?this.secondRingId=e:this.firstRingId=e}},{key:"containsRing",value:function(e){return this.firstRingId===e||this.secondRingId===e}},{key:"isBridge",value:function(e){if(2<this.vertices.size)return!0;var t,i=!0,n=!1;try{for(var r,o,a=this.vertices[Symbol.iterator]();!(i=(r=a.next()).done);i=!0)if(o=r.value,2<e[o].value.rings.length)return!0}catch(e){n=!0,t=e}finally{try{!i&&a.return&&a.return()}finally{if(n)throw t}}return!1}}],[{key:"isBridge",value:function(e,t,i,n){for(var r=null,o=0;o<e.length;o++)if(r=e[o],r.firstRingId===i&&r.secondRingId===n||r.firstRingId===n&&r.secondRingId===i)return r.isBridge(t);return!1}},{key:"getNeighbours",value:function(e,t){for(var i,n=[],r=0;r<e.length;r++)i=e[r],i.firstRingId===t?n.push(i.secondRingId):i.secondRingId===t&&n.push(i.firstRingId);return n}},{key:"getVertices",value:function(e,t,i){for(var n,o=0;o<e.length;o++)if(n=e[o],n.firstRingId===t&&n.secondRingId===i||n.firstRingId===i&&n.secondRingId===t)return[].concat(r(n.vertices))}}]),e}());i.default=a},{"./Ring":11,"./Vertex":15}],13:[function(e,t,i){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}Object.defineProperty(i,"__esModule",{value:!0});var r,o=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=e("./Graph"),s=(r=a)&&r.__esModule?r:{default:r},l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return o(e,null,[{key:"getRings",value:function(t){var i=t.getComponentsAdjacencyMatrix();if(0===i.length)return null;for(var r=s.default.getConnectedComponents(i),o=[],a=0;a<r.length;a++){for(var l=r[a],h=t.getSubgraphAdjacencyMatrix([].concat(n(l))),c=new Uint16Array(h.length),u=new Uint16Array(h.length),d=0;d<h.length;d++){u[d]=0,c[d]=0;for(var g=0;g<h[d].length;g++)c[d]+=h[d][g]}var p=0;for(d=0;d<h.length;d++)for(g=d+1;g<h.length;g++)p+=h[d][g];var f=p-h.length+1,v=!0;for(d=0;d<c.length;d++)3!==c[d]&&(v=!1);if(v&&(f=2+p-h.length),1!=f){var _=e.getPathIncludedDistanceMatrices(h),y=_.d,m=_.pe,b=_.pe_prime,x=e.getRingCandidates(y,m,b),w=e.getSSSR(x,y,h,m,b,c,u,f);for(d=0;d<w.length;d++){var k=Array(w[d].size),S=0,C=!0,A=!1,R=void 0;try{for(var T,z,P=w[d][Symbol.iterator]();!(C=(T=P.next()).done);C=!0)z=T.value,k[S++]=l[z]}catch(e){A=!0,R=e}finally{try{!C&&P.return&&P.return()}finally{if(A)throw R}}o.push(k)}}else o.push([].concat(n(l)))}return o}},{key:"matrixToString",value:function(e){for(var t="",i=0;i<e.length;i++){for(var n=0;n<e[i].length;n++)t+=e[i][n]+" ";t+="\n"}return t}},{key:"getPathIncludedDistanceMatrices",value:function(e){for(var t=e.length,i=Array(t),n=Array(t),r=Array(t),o=0,a=0,s=0,l=t;l--;){i[l]=Array(t),n[l]=Array(t),r[l]=Array(t);for(var h=t;h--;)i[l][h]=l===h||1===e[l][h]?e[l][h]:Number.POSITIVE_INFINITY,n[l][h]=1===i[l][h]?[[[l,h]]]:[],r[l][h]=[]}for(var c=t;c--;)for(l=t;l--;)for(h=t;h--;){var u=i[l][h],d=i[l][c]+i[c][h];if(u>d){if(u===d+1)for(r[l][h]=[n[l][h].length],o=n[l][h].length;o--;)for(r[l][h][o]=[n[l][h][o].length],a=n[l][h][o].length;a--;)for(r[l][h][o][a]=[n[l][h][o][a].length],s=n[l][h][o][a].length;s--;)r[l][h][o][a][s]=[n[l][h][o][a][0],n[l][h][o][a][1]];else r[l][h]=[];for(i[l][h]=d,n[l][h]=[[]],o=n[l][c][0].length;o--;)n[l][h][0].push(n[l][c][0][o]);for(o=n[c][h][0].length;o--;)n[l][h][0].push(n[c][h][0][o])}else if(u===d){if(n[l][c].length&&n[c][h].length)if(n[l][h].length){var g=[];for(o=n[l][c][0].length;o--;)g.push(n[l][c][0][o]);for(o=n[c][h][0].length;o--;)g.push(n[c][h][0][o]);n[l][h].push(g)}else{var p=[];for(o=n[l][c][0].length;o--;)p.push(n[l][c][0][o]);for(o=n[c][h][0].length;o--;)p.push(n[c][h][0][o]);n[l][h][0]=p}}else if(u===d-1){if(r[l][h].length){var f=[];for(o=n[l][c][0].length;o--;)f.push(n[l][c][0][o]);for(o=n[c][h][0].length;o--;)f.push(n[c][h][0][o]);r[l][h].push(f)}else{var v=[];for(o=n[l][c][0].length;o--;)v.push(n[l][c][0][o]);for(o=n[c][h][0].length;o--;)v.push(n[c][h][0][o]);r[l][h][0]=v}}}return{d:i,pe:n,pe_prime:r}}},{key:"getRingCandidates",value:function(e,t,i){for(var n=e.length,r=[],o=0,a=0;a<n;a++)for(var s=0;s<n;s++){if(0===e[a][s]||1===t[a][s].length&&0===i[a][s])continue;(o=0===i[a][s].length?2*e[a][s]:2*(e[a][s]+.5))!=1/0&&r.push([o,t[a][s],i[a][s]])}return r.sort(function(e,t){return e[0]-t[0]}),r}},{key:"getSSSR",value:function(t,i,n,r,o,a,s,l){for(var h=[],c=[],u=0;u<t.length;u++)if(0!=t[u][0]%2)for(var d,g=0;g<t[u][2].length;g++){d=t[u][1][0].concat(t[u][2][g]);for(var p=0;p<d.length;p++)d[p][0].constructor===Array&&(d[p]=d[p][0]);var f=e.bondsToAtoms(d);if(e.getBondCount(f,n)!==f.size||e.pathSetsContain(h,f,d,c,a,s)||(h.push(f),c=c.concat(d)),h.length>l)return h}else for(var v,_=0;_<t[u][1].length-1;_++){v=t[u][1][_].concat(t[u][1][_+1]);for(p=0;p<v.length;p++)v[p][0].constructor===Array&&(v[p]=v[p][0]);var y=e.bondsToAtoms(v);if(e.getBondCount(y,n)!==y.size||e.pathSetsContain(h,y,v,c,a,s)||(h.push(y),c=c.concat(v)),h.length>l)return h}return h}},{key:"getEdgeCount",value:function(e){for(var t=0,i=e.length,n=i-1;n--;)for(var r=i;r--;)1===e[n][r]&&t++;return t}},{key:"getEdgeList",value:function(e){for(var t=e.length,i=[],n=t-1;n--;)for(var r=t;r--;)1===e[n][r]&&i.push([n,r]);return i}},{key:"bondsToAtoms",value:function(e){for(var t=new Set,i=e.length;i--;)t.add(e[i][0]),t.add(e[i][1]);return t}},{key:"getBondCount",value:function(e,t){var i,n=0,r=!0,o=!1;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var l=a.value,h=!0,c=!1,u=void 0;try{for(var d,g,p=e[Symbol.iterator]();!(h=(d=p.next()).done);h=!0)g=d.value,l!==g&&(n+=t[l][g])}catch(e){c=!0,u=e}finally{try{!h&&p.return&&p.return()}finally{if(c)throw u}}}}catch(e){o=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw i}}return n/2}},{key:"pathSetsContain",value:function(t,i,n,r,o,a){for(var s=t.length;s--;){if(e.isSupersetOf(i,t[s]))return!0;if(t[s].size===i.size&&e.areSetsEqual(t[s],i))return!0}var l=0,h=!1;for(s=n.length;s--;)for(var c=r.length;c--;)(n[s][0]===r[c][0]&&n[s][1]===r[c][1]||n[s][1]===r[c][0]&&n[s][0]===r[c][1])&&l++,l===n.length&&(h=!0);var u=!1;if(h){var d,g=!0,p=!1;try{for(var f,v,_=i[Symbol.iterator]();!(g=(f=_.next()).done);g=!0)if(v=f.value,a[v]<o[v]){u=!0;break}}catch(e){p=!0,d=e}finally{try{!g&&_.return&&_.return()}finally{if(p)throw d}}}if(h&&!u)return!0;var y,m=!0,b=!1;try{for(var x,w,k=i[Symbol.iterator]();!(m=(x=k.next()).done);m=!0)w=x.value,a[w]++}catch(e){b=!0,y=e}finally{try{!m&&k.return&&k.return()}finally{if(b)throw y}}return!1}},{key:"areSetsEqual",value:function(e,t){if(e.size!==t.size)return!1;var i,n=!0,r=!1;try{for(var o,a,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0)if(a=o.value,!t.has(a))return!1}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}return!0}},{key:"isSupersetOf",value:function(e,t){var i,n=!0,r=!1;try{for(var o,a,s=t[Symbol.iterator]();!(n=(o=s.next()).done);n=!0)if(a=o.value,!e.has(a))return!1}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}return!0}}]),e}();i.default=l},{"./Graph":7}],14:[function(e,t,i){"use strict";var n=Math.sin,r=Math.cos,o=Math.sqrt;Object.defineProperty(i,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=function(){function e(t,i){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=t.x,this.y=t.y):(this.x=t,this.y=i)}var t=Math.acos;return a(e,[{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"divide",value:function(e){return this.x/=e,this.y/=e,this}},{key:"multiply",value:function(e){return this.x*=e.x,this.y*=e.y,this}},{key:"multiplyScalar",value:function(e){return this.x*=e,this.y*=e,this}},{key:"invert",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(e){return o((e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y))}},{key:"distanceSq",value:function(e){return(e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y)}},{key:"clockwise",value:function(e){var t=this.y*e.x,i=this.x*e.y;return t>i?-1:t==i?0:1}},{key:"relativeClockwise",value:function(e,t){var i=(this.y-e.y)*(t.x-e.x),n=(this.x-e.x)*(t.y-e.y);return i>n?-1:i==n?0:1}},{key:"rotate",value:function(t){var i=new e(0,0),o=r(t),a=n(t);return i.x=this.x*o-this.y*a,i.y=this.x*a+this.y*o,this.x=i.x,this.y=i.y,this}},{key:"rotateAround",value:function(e,t){var i=n(e),o=r(e);this.x-=t.x,this.y-=t.y;var a=this.x*o-this.y*i,s=this.x*i+this.y*o;return this.x=a+t.x,this.y=s+t.y,this}},{key:"rotateTo",value:function(t,i){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;this.x+=.001,this.y-=.001;var r=e.subtract(this,i),o=e.subtract(t,i),a=e.angle(o,r);return this.rotateAround(a+n,i),this}},{key:"rotateAwayFrom",value:function(e,t,i){this.rotateAround(i,t);var n=this.distanceSq(e);this.rotateAround(-2*i,t),this.distanceSq(e)<n&&this.rotateAround(2*i,t)}},{key:"getRotateAwayFromAngle",value:function(e,t,i){var n=this.clone();n.rotateAround(i,t);var r=n.distanceSq(e);return n.rotateAround(-2*i,t),n.distanceSq(e)<r?i:-i}},{key:"getRotateTowardsAngle",value:function(e,t,i){var n=this.clone();n.rotateAround(i,t);var r=n.distanceSq(e);return n.rotateAround(-2*i,t),n.distanceSq(e)>r?i:-i}},{key:"getRotateToAngle",value:function(t,i){var n=e.subtract(this,i),r=e.subtract(t,i),o=e.angle(r,n);return Number.isNaN(o)?0:o}},{key:"isInPolygon",value:function(e){for(var t=!1,i=0,n=e.length-1;i<e.length;n=i++)e[i].y>this.y!=e[n].y>this.y&&this.x<(e[n].x-e[i].x)*(this.y-e[i].y)/(e[n].y-e[i].y)+e[i].x&&(t=!t);return t}},{key:"length",value:function(){return o(this.x*this.x+this.y*this.y)}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){return this.divide(this.length()),this}},{key:"normalized",value:function(){return e.divideScalar(this,this.length())}},{key:"whichSide",value:function(e,t){return(this.x-e.x)*(t.y-e.y)-(this.y-e.y)*(t.x-e.x)}},{key:"sameSideAs",value:function(e,t,i){var n=this.whichSide(e,t),r=i.whichSide(e,t);return 0>n&&0>r||0==n&&0==r||0<n&&0<r}}],[{key:"add",value:function(t,i){return new e(t.x+i.x,t.y+i.y)}},{key:"subtract",value:function(t,i){return new e(t.x-i.x,t.y-i.y)}},{key:"multiply",value:function(t,i){return new e(t.x*i.x,t.y*i.y)}},{key:"multiplyScalar",value:function(t,i){return new e(t.x,t.y).multiplyScalar(i)}},{key:"midpoint",value:function(t,i){return new e((t.x+i.x)/2,(t.y+i.y)/2)}},{key:"normals",value:function(t,i){var n=e.subtract(i,t);return[new e(-n.y,n.x),new e(n.y,-n.x)]}},{key:"units",value:function(t,i){var n=e.subtract(i,t);return[new e(-n.y,n.x).normalize(),new e(n.y,-n.x).normalize()]}},{key:"divide",value:function(t,i){return new e(t.x/i.x,t.y/i.y)}},{key:"divideScalar",value:function(t,i){return new e(t.x/i,t.y/i)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"angle",value:function(i,n){var r=e.dot(i,n);return t(r/(i.length()*n.length()))}},{key:"threePointangle",value:function(i,n,r){var o=e.subtract(n,i),a=e.subtract(r,n),s=i.distance(n),l=n.distance(r);return t(e.dot(o,a)/(s*l))}},{key:"scalarProjection",value:function(t,i){var n=i.normalized();return e.dot(t,n)}},{key:"averageDirection",value:function(t){for(var i,n=new e(0,0),r=0;r<t.length;r++)i=t[r],n.add(i);return n.normalize()}}]),e}();i.default=s},{}],15:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var r=Math.round;Object.defineProperty(i,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i,n=0;n<t.length;n++)i=t[n],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=n(e("./MathHelper")),s=n(e("./ArrayHelper")),l=n(e("./Vector2")),h=(n(e("./Atom")),function(){function e(t){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.id=null,this.value=t,this.position=new l.default(i||0,n||0),this.previousPosition=new l.default(0,0),this.parentVertexId=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=null,this.dir=1,this.neighbourCount=0,this.neighbours=[],this.neighbouringElements=[],this.forcePositioned=!1}return o(e,[{key:"setPosition",value:function(e,t){this.position.x=e,this.position.y=t}},{key:"setPositionFromVector",value:function(e){this.position.x=e.x,this.position.y=e.y}},{key:"addChild",value:function(e){this.children.push(e),this.neighbours.push(e),this.neighbourCount++,this.value.bondCount++}},{key:"addRingbondChild",value:function(e,t){if(this.children.push(e),this.value.bracket){var i=1;0===this.id&&0===this.value.bracket.hcount&&(i=0),1===this.value.bracket.hcount&&0===t&&(i=2),1===this.value.bracket.hcount&&1===t&&(i=3>this.neighbours.length?2:3),null===this.value.bracket.hcount&&0===t&&(i=1),null===this.value.bracket.hcount&&1===t&&(i=3>this.neighbours.length?1:2),this.neighbours.splice(i,0,e)}else this.neighbours.push(e);this.neighbourCount++,this.value.bondCount++}},{key:"setParentVertexId",value:function(e){this.neighbourCount++,this.parentVertexId=e,this.neighbours.push(e),this.value.bondCount++}},{key:"isTerminal",value:function(){return!!this.value.hasAttachedPseudoElements||null===this.parentVertexId&&2>this.children.length||0===this.children.length}},{key:"clone",value:function(){var t=new e(this.value,this.position.x,this.position.y);return t.id=this.id,t.previousPosition=new l.default(this.previousPosition.x,this.previousPosition.y),t.parentVertexId=this.parentVertexId,t.children=s.default.clone(this.children),t.spanningTreeChildren=s.default.clone(this.spanningTreeChildren),t.edges=s.default.clone(this.edges),t.positioned=this.positioned,t.angle=this.angle,t.forcePositioned=this.forcePositioned,t}},{key:"equals",value:function(e){return this.id===e.id}},{key:"getAngle",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=null;return i=e?l.default.subtract(this.position,e):l.default.subtract(this.position,this.previousPosition),t?a.default.toDeg(i.angle()):i.angle()}},{key:"getTextDirection",value:function(e){for(var t=this.getDrawnNeighbours(e),i=[],n=0;n<t.length;n++)i.push(this.getAngle(e[t[n]].position));var o=a.default.meanAngle(i),s=Math.PI/2;return 2===(o=r(r(o/s)*s))?"down":-2===o?"up":0===o||-0===o?"right":3===o||-3===o?"left":"down"}},{key:"getNeighbours",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;if(null===e)return this.neighbours.slice();for(var t=[],i=0;i<this.neighbours.length;i++)this.neighbours[i]!==e&&t.push(this.neighbours[i]);return t}},{key:"getDrawnNeighbours",value:function(e){for(var t=[],i=0;i<this.neighbours.length;i++)e[this.neighbours[i]].value.isDrawn&&t.push(this.neighbours[i]);return t}},{key:"getNeighbourCount",value:function(){return this.neighbourCount}},{key:"getSpanningTreeNeighbours",value:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=[],i=0;i<this.spanningTreeChildren.length;i++)(void 0===e||e!=this.spanningTreeChildren[i])&&t.push(this.spanningTreeChildren[i]);return null!=this.parentVertexId&&(void 0===e||e!=this.parentVertexId)&&t.push(this.parentVertexId),t}},{key:"getNextInRing",value:function(e,t,i){for(var n=this.getNeighbours(),r=0;r<n.length;r++)if(s.default.contains(e[n[r]].value.rings,{value:t})&&n[r]!=i)return n[r];return null}}]),e}());i.default=h},{"./ArrayHelper":2,"./Atom":3,"./MathHelper":9,"./Vector2":14}]},{},[1]);var _date=new Date;!function(e){(ChemSpace=function(t){var i=this;i.user_settings=t,i.target_element=e("#"+t.target);var n=i.target_element.width();i.settings={target:"YourOwnDivId",height:800,width:n,font:"Helvetica",label_color:"gray",shapes:{order:["circle","triangle","square","hexagon","rhombus"],default:{radius:4,strokeWidth:1,fill:"#C2C2C2",stroke:null,shadowForStrokeEnabled:!1},circle:{transformsEnabled:"position"},square:{sides:4,rotation:45,transformsEnabled:"all"},hexagon:{sides:6,transformsEnabled:"position"},triangle:{sides:3,transformsEnabled:"position"},rhombus:{sides:4,transformsEnabled:"position"}},path:{strokeWidth:1,stroke:"gray"},links:{draw:!0,attrs:{strokeWidth:1.5,stroke:"#777777"}},color:{scale:"RdLrGr",value_type:"percentile",index:2,params:{min:5,max:95,middle:50}},point_size:{scale:{min:2,middle:4,max:6},value_type:"percentile",index:3,params:{min:5,max:95,middle:50}},coordinates:{x:0,y:1},highlight_color:"black",navigation_toggle:{axis_labels:!0,axis:!0,diagonal:!0,export_button:!0,color_scale:!0,point_size:!0},align_to_grid:!1,compounds:{compound_url:null,format:"chemspace",draw:!0,limit:50,size:200,tooltip_compound_size:200,smilesDrawer:{bondThickness:1,fontSizeLarge:7,fontSizeSmall:4}},categories:{order:!1},resolution:1,colors:["#d62728","#2ca02c","#1f77b4","#ff7f0e","#aec7e8","#ffbb78","#98df8a","#ff9896","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7","#dbdb8d","#9edae5"]};for(var r=0,o=i.settings.shapes.order.length;r<o;r++){var a=i.settings.shapes.order[r];i.settings.shapes[a]=e.extend(i.settings.shapes[a],i.settings.shapes.default)}i.update_settings(t),i.target_element.css({position:"relative","font-family":i.settings.font}),i.events={point_click:function(e,t){},path_click:function(e,t){},link_click:function(e,t){},points_selection:function(e){},category_legend_click:function(e,t){},refresh:function(e,t){},point_tooltip:function(e,t,n){return i._get_point_tooltip(n)}},i.colors={RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,g:255,b:178}},RdYlGr:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},GrBkRd:{start:{r:35,g:139,b:69},middle:{r:0,g:0,b:0},end:{r:215,g:25,b:28}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}}},i.objects_ref={path:new Konva.Line({stroke:"gray",strokeWidth:i.settings.path.strokeWidth,lineCap:"round",lineJoin:"round",opacity:.7,class:"path"}),link:new Konva.Line({stroke:i.settings.links.attrs.stroke,strokeWidth:i.settings.links.attrs.strokeWidth,lineCap:"round",lineJoin:"round",opacity:.7,class:"link"}),selection_rect:new Konva.Rect({width:0,height:0,fill:"#D2D2D2",opacity:.3,listening:!1}),icon:new Konva.Path({fill:"grey",class:"icon",listening:!1}),icon_overlay:new Konva.Rect({width:32,height:32,opacity:0,class:"icon"}),legend_text:new Konva.Text({fontFamily:i.settings.font,fontSize:14,fill:"#333333",lineHeight:1.2}),legend_circle:new Konva.Circle({radius:6,strokeWidth:3}),hover_overlay_rect:new Konva.Rect({listening:!1,opacity:.8,fill:"white",width:i.settings.width,x:i.left_margin}),tooltip_label:new Konva.Label({opacity:1,listening:!1}),tooltip_tag:new Konva.Tag({fill:i.settings.label_color,pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:!1}),tooltip_text:new Konva.Text({fontFamily:i.settings.font,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:!1,align:"center",lineHeight:1.2}),arrow:new Konva.Arrow({pointerLength:10,pointerWidth:7,fill:"#B2B2B2",stroke:"#B2B2B2",listening:!1}),diagonal:new Konva.Line({stroke:"#B2B2B2",strokeWidth:2,lineCap:"round",dash:[10,5],listening:!1}),border_line:new Konva.Line({stroke:"#B2B2B2",strokeWidth:1,lineCap:"round",dash:[4,2],listening:!1}),rect_gradient:new Konva.Rect({x:0,y:80,height:30,fillLinearGradientStartPoint:{x:0,y:80},stroke:"#D2D2D2",strokeWidth:"1px"}),percentile_line:new Konva.Line({stroke:"#393939",strokeWidth:.5,lineCap:"round"}),navigation_text:new Konva.Text({fill:"#333333",fontStyle:"bold",fontFamily:i.settings.font})},i.objects_ref.shapes={};for(r=0,o=i.settings.shapes.order.length;r<o;r++){a=i.settings.shapes.order[r];var s=e.extend(i.settings.shapes[a],{class:"point"});i.objects_ref.shapes[a]="circle"===a?new Konva.Circle(s):new Konva.RegularPolygon(s)}if(i.shape_fnc=function(e,t,n,r,o,a,s){return i.objects_ref.shapes[e].clone({x:r,y:o,point_ids:n,fill:s,radius:a,id:t})},i.mol_objects_ref={single_bond:new Konva.Line({stroke:"#393939",strokeWidth:.5,lineCap:"round"}),atom_circle:new Konva.Circle,atom_background:new Konva.Rect({fill:"#ffffff",cornerRadius:2}),atom_symbol:new Konva.Text({fontFamily:i.settings.font,fontStyle:"bold"})},i.symbol2color={N:"#2a76b8",S:"#ec7f35",O:"#cf282b",F:"#0ed7e7",Cl:"#399757",Br:"#399757",Si:"#6d6966"},i.paths_ref={zoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",unzoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",options_icon:"M4.082,4.083v2.999h22.835V4.083H4.082zM4.082,20.306h22.835v-2.999H4.082V20.306zM4.082,13.694h22.835v-2.999H4.082V13.694zM4.082,26.917h22.835v-2.999H4.082V26.917z",refresh_icon:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",export_icon:"M24.25,10.25H20.5v-1.5h-9.375v1.5h-3.75c-1.104,0-2,0.896-2,2v10.375c0,1.104,0.896,2,2,2H24.25c1.104,0,2-0.896,2-2V12.25C26.25,11.146,25.354,10.25,24.25,10.25zM15.812,23.499c-3.342,0-6.06-2.719-6.06-6.061c0-3.342,2.718-6.062,6.06-6.062s6.062,2.72,6.062,6.062C21.874,20.78,19.153,23.499,15.812,23.499zM15.812,13.375c-2.244,0-4.062,1.819-4.062,4.062c0,2.244,1.819,4.062,4.062,4.062c2.244,0,4.062-1.818,4.062-4.062C19.875,15.194,18.057,13.375,15.812,13.375z"},i.shape_events={mouseover:{point:function(e){i._point_mouseover(e)},path:function(e){i._path_mouseover(e)},link:function(e){i._link_mouseover(e)},Rect:function(e){},category_legend:function(e){i._category_legend_mouseover(e)},icon:function(e){i._icon_mouseover(e)}},mouseout:{point:function(e){i._point_mouseout(e)},path:function(e){i._point_mouseout(e)},link:function(e){i._link_mouseout(e)},category_legend:function(e){i._category_legend_mouseout(e)},icon:function(e){i._icon_mouseout(e)},Rect:function(e){}},click:{point:function(e){i._point_click(e)},path:function(e){i._path_click(e)},link:function(e){i._link_click(e)},category_legend:function(e){i._category_legend_click(e)},icon:function(e){i._icon_click(e)},Rect:function(e){}}},i.html_ref={tooltip:e("<div class='point_tooltip'>            <div class='compound_img'><canvas id='tooltip_compound_img'></canvas></div>            <div class='point_id'></div>            <div class='dimensions'></div>          </div>").css({border:"solid #D2D2D2 3px",padding:10,"background-color":"white","word-break":"break-all","max-width":i.settings.compounds.tooltip_compound_size+20}),redraw_button:e('<div class="redraw_button">Redraw</div>').css({padding:5,color:"white",border:"solid #D2D2D2 1px",margin:"5px 0px","background-color":"#2171b5","font-weight":"bold","text-align":"center"}),menu:e("<div></div>").css({position:"absolute",border:"solid #D2D2D2 2px",padding:"4px 10px","font-size":"small","background-color":"white","z-index":1e3,color:"#333333"}),menu_subtitle:e("<div></div>").css({"font-weight":"bold",padding:"5px 0px"})},i.target_element.append(i.html_ref.tooltip),i.settings.compounds.draw){i.img_cache=e("<canvas id='chemspace_img_cache'></canvas>").css({position:"fixed",top:-1e3}),e("body").append(i.img_cache);var l=e.extend({},i.settings.compounds.smilesDrawer);l.width=i.settings.compounds.size,l.height=i.settings.compounds.size,i.smilesDrawer=new SmilesDrawer.Drawer(l);var h=e.extend({},i.settings.compounds.smilesDrawer);h.width=i.settings.compounds.tooltip_compound_size,h.height=i.settings.compounds.tooltip_compound_size,i.tooltipSmilesDrawer=new SmilesDrawer.Drawer(h)}i._prop2settings={color:e.extend(!0,{},i.settings.color),point_size:e.extend(!0,{},i.settings.point_size),coordinates:e.extend(!0,{},i.settings.coordinates)},i._prop2settings.color.scale="init",i._prop2settings.point_size.scale="init",i._prop2settings.coordinates.x=-1,i._prop2fnc={color:{category:function(e){return e.color},feature:function(e){return i._get_color_for_value(e,i._prop2settings.color.values.min,i._prop2settings.color.values.max,i._prop2settings.color.values.middle,i.settings.color.scale)}},point_size:{category:function(e){return e.radius},feature:function(e){return i._get_point_size(e,i._prop2settings.point_size.values,i.settings.point_size.scale)}}}}).prototype.update_settings=function(t){for(var i=[["shapes",["circle"]],["point_size",["params","scale"]],["coordinates"],["navigation_toggle"],["compounds"],["color",["params","scale"]],["links",["attrs"]]],n=0,r=i.length;n<r;n++)if(void 0!==t[i[n][0]]){if(i[n].length>1)for(var o=0,a=i[n][1].length;o<a;o++)void 0!==t[i[n][0]][i[n][1][o]]&&(e.extend(this.settings[i[n][0]][i[n][1][o]],t[i[n][0]][i[n][1][o]]),delete t[i[n][0]][i[n][1][o]]);e.extend(this.settings[i[n][0]],t[i[n][0]]),delete t[i[n][0]]}e.extend(this.settings,t)},ChemSpace.prototype._shapes_init=function(){},ChemSpace.prototype.read_data=function(e){var t=this;t.data=e,t.header_height=140,t.footer_height=40,t.left_margin=30,t.right_margin=40,t.point_ids=Object.keys(t.data.points),t.points_len=t.point_ids.length,t._process_categories(t.data.categories),t.id2categories=t._get_id2categories(),t._get_links_feature(),t.settings.compounds.draw&&(void 0===t.data.compounds&&""!==t.settings.compounds.compound_url?t.data.compounds={}:void 0===t.data.compounds&&(t.settings.compounds.draw=!1));var i=t.data.points[t.point_ids[0]].features.length;if(void 0===t.data.feature_names){t.data.feature_names=[];for(var n=0;n<i;n++)t.data.feature_names.push("Feature "+(n+1))}t.objects_ref.hover_overlay_rect.setAttrs({y:t.header_height,height:t.settings.height-t.header_height})},ChemSpace.prototype.read_data_from_file=function(t){var i=this;e.ajax({type:"GET",url:t,dataType:"json",success:function(e){i.read_data(e)},async:!1})},ChemSpace.prototype._add_prefix_to_data=function(e){for(var t={},i=0,n=Object.keys(e),r=n.length;i<r;i++)t[[this.settings.target,n[i]].join("#")]=e[n[i]];return t},ChemSpace.prototype._draw_stage_layer=function(){var e=this;e.stage_layer=new Konva.Layer,e.stage_rect=new Konva.Rect({x:0,y:0,width:e.settings.width,height:e.settings.height,opacity:0}),e.stage_layer.add(e.stage_rect),e.stage_rect.moveToBottom(),e.stage.add(e.stage_layer),e.stage_rect.on("click",function(t){e.selection_rect&&(e.selection_rect.destroy(),e.zoom_icon.destroy(),e.selection_layer.draw())})},ChemSpace.prototype._destroy_children=function(e){for(var t=0,i=e.length;t<i;t++)e[t].destroyChildren()},ChemSpace.prototype.add_feature=function(t){var i=this;if(i.data.feature_names.indexOf(t.name)>-1)alert("Feature '"+t.name+"' already exists.");else{for(var n=0,r=i.points_len;n<r;n++){var o=i.point_ids[n];void 0!==t.point2value[o]?i.data.points[o].features.push(t.point2value[o]):i.data.points[o].features.push(null)}i.data.feature_names.push(t.name);var a=i.target_element.find(".navigation select"),s=i.data.feature_names.length-1;for(n=0,r=a.length;n<r;n++)e(a[n]).append("<option value='"+s+"''>"+t.name+"</option>")}},ChemSpace.prototype.remove_feature=function(e){var t=this,i=t.data.feature_names.indexOf(e);if(i>-1){t.data.feature_names.splice(i,1);for(var n=0,r=t.points_len;n<r;n++){var o=t.point_ids[n];t.data.points[o].features.splice(i,1)}t.target_element.find(".navigation select option[value='"+i+"']").remove()}},ChemSpace.prototype.add_category=function(e){var t=this;void 0===t.data.categories&&(t.data.categories=[]),t.categories=[],t.category2layer={},t.data.categories.push(e),t._process_categories(t.data.categories),t.id2categories=t._get_id2categories(),t._sort_layers()},ChemSpace.prototype.update_category=function(e,t){var i=this;if(void 0===t)t="update";var n=!1;if(i._prop2settings.color.scale="init",i._prop2settings.point_size.scale="init",i._prop2settings.coordinates.x=-1,void 0!==i.data.categories){for(var r=i.data.categories.length,o=0;o<r;o++){if(i.data.categories[o].label===e.label){"update"===t?i.data.categories[o]=e:"remove"===t&&i.data.categories.splice(o,1),n=!0;break}}n?(i.categories=[],i.category2layer={},i._process_categories(i.data.categories),i.id2categories=i._get_id2categories(),i._sort_layers()):i.add_category(e)}else i.add_category(e)},ChemSpace.prototype.remove_category=function(e){this.update_category({label:e},"remove")},ChemSpace.prototype.add_path=function(e){var t=this;void 0===t.data.paths&&(t.data.paths=[]),t.data.paths.push(e),void 0!=t.path_layer?t.path_layer.destroyChildren():(t.path_layer=new Konva.Layer,t.stage.add(t.path_layer)),t._draw_paths(),t._sort_layers()},ChemSpace.prototype.unhighlight_points=function(){this.highlight_layer.destroyChildren(),this.highlight_layer.draw()},ChemSpace.prototype.highlight_points=function(e,t){var i=this,n=e.length;if(void 0!==t&&(i.settings.highlight_color=t),void 0===i.highlight_layer?(i.highlight_layer=new Konva.Layer,i.stage.add(i.highlight_layer)):i.highlight_layer.destroyChildren(),i.highlighted_points=e,n>0){for(var r=0;r<n;r++)i.highlight_layer.add(i.stage.find("#"+i.point2id[i.highlighted_points[r]])[0].clone({listening:!1,fill:i.settings.highlight_color}));i.highlight_layer.draw()}else i.unhighlight_points()},ChemSpace.prototype.redraw=function(){this.stage.destroy(),this.stage=void 0,this.draw()},ChemSpace.prototype.redraw_points=function(e){var t=this;void 0!==t.path_layer&&t.path_layer.destroyChildren(),t._draw_points(e),void 0!==t.data.paths&&t._draw_paths(),t._sort_layers()},ChemSpace.prototype._prepare_canvas=function(){var e=this;e.current_selection=[],e.stage=new Konva.Stage({container:e.settings.target}),e.stage.setWidth(e.settings.width),e.stage.setHeight(e.settings.height),e._draw_stage_layer()},ChemSpace.prototype.draw=function(){var t=this;void 0===t.stage&&t._prepare_canvas(),t.highlighted_points=[],t.fixed_compounds=[],t.selection_overlay_rect=new Konva.Rect({fill:"white",opacity:.9,x:t.left_margin,y:t.header_height,width:t.settings.width-t.right_margin-t.left_margin,height:t.settings.height-t.header_height-t.footer_height}),t.current_selection={x:[t.left_margin,t.settings.width-t.right_margin-t.left_margin],y:[t.header_height,t.settings.height-t.header_height-t.footer_height]},t.main_layer=new Konva.Layer,t.main_layer.add(t.selection_overlay_rect),t.link_layer=new Konva.Layer,t._draw_points(),t._draw_menu(),t._draw_legend(),t.point2img={},t.settings.compounds.draw&&(t.data.compounds>0||null!==t.settings.compounds.compound_url)&&t._draw_compounds(),t.hover_layer=new Konva.Layer({listening:!1}),t.stage.add(t.link_layer,t.main_layer,t.hover_layer),void 0!==t.data.paths&&(t.path_layer=new Konva.Layer,t._draw_paths(),t.stage.add(t.path_layer)),t._bind_hover_events_on_stage(),t.selection_rect=!1,t.down=!1,t.selection_layer=new Konva.Layer,t.stage.add(t.selection_layer),t.selection_layer.moveToBottom(),t.selection_background_rect=t.selection_overlay_rect.clone({opacity:0,listening:!1}),t.selection_layer.add(t.selection_background_rect),t.stage_layer.moveToBottom(),t.stage.draw(),t._sort_layers(),t.main_layer.on("mousedown",function(i){t.selection_background_rect.listening(!0),t.selection_layer.draw(),t.selection_rect&&(t.selection_rect.destroy(),t.selection_rect=!1,t.zoom_icon.destroy()),t.down=!0,t.selection_layer.moveToTop(),t.selection_rect=t.objects_ref.selection_rect.clone({x:i.evt.offsetX,y:i.evt.offsetY}),t.selection_layer.add(t.selection_rect),t.stage.off("mouseover"),t.stage.off("mouseout"),t.stage.off("click"),e(document).one("mouseup",function(){t.selection_layer.fire("mouseup")})}),t.selection_layer.on("mousemove",function(e){if(t.down){e=e.evt;var i=t.selection_rect.attrs,n=e.layerX-i.x,r=e.layerY-i.y;n*r!=0&&t.stage_layer.off("click"),t.selection_rect.width(n),t.selection_rect.height(r),t.selection_layer.draw()}}),t.selection_layer.on("mouseup",function(e){if(t.down){t.selection_background_rect.listening(!1),t.selection_layer.draw(),t.down=!1;var i=t.selection_rect.attrs;if(void 0!==i){if(t.selection_range={x:[i.x,i.x+i.width],y:[i.y,i.y+i.height]},t.selection_range.x.sort(t._sort_number_ascending),t.selection_range.y.sort(t._sort_number_ascending),t.current_selection=t.get_points_by_range(t.selection_range),t._bind_hover_events_on_stage(),0===i.width||0===t.current_selection.length)return t.selection_rect.destroy(),t.selection_rect=!1,void t.selection_layer.draw();var n=t.selection_rect.width();n=n>0?n:0;var r=t.selection_rect.height();r=r<0?r:0;var o=t.selection_rect.getAttr("x")+n+5,a=t.selection_rect.getAttr("y")+r+5;t.zoom_icon=t._get_icon_group("zoom_icon","Zoom in",o,a),t.zoom_icon.children[1].setAttrs({fill:"white",opacity:.7}),t.zoom_icon.children[1].moveToBottom(),t.selection_layer.add(t.zoom_icon),t.selection_layer.draw(),t.events.points_selection(t.current_selection)}}})},ChemSpace.prototype._bind_hover_events_on_stage=function(){var e=this;e.stage.on("click",function(t){void 0!==t.target.attrs.class&&e.shape_events[t.type][t.target.attrs.class](t)}),e.stage.on("mouseover",function(t){void 0!==t.target.attrs.class&&e.shape_events[t.type][t.target.attrs.class](t)}),e.stage.on("mouseout",function(t){void 0!==t.target.attrs.class&&e.shape_events[t.type][t.target.attrs.class](t)})},ChemSpace.prototype._draw_points=function(e){console.time("DRAW POINTS");var t,i,n,r,o,a,s,l,h,c,u,d,g=this,p=g.data.feature_names.indexOf("Point count");-1===p&&(g.data.feature_names.push("Point count"),p=g.data.feature_names.length-1);var f=g._calculate_coordinates(e),v=g._get_prop_settings("color"),_=g._get_prop_settings("point_size");if(!f||!_||!v){g._destroy_children(Object.values(g.category2layer)),g._id2object={},g.category2count={},g.point2id={},g.id2points={};for(var y=0,m=g.categories.length;y<m;y++)g.category2count[y]=0;for(var b=0,x=(y=0,(s=g._shuffle(Object.keys(g.point_index))).length);y<x;y++){l=s[y];for(var w=0,k=(h=Object.keys(g.point_index[l])).length;w<k;w++){c=h[w],u={},a=[];for(var S=0,C=d=(e=g.point_index[l][c]).length;S<C;S++){r=e[S],g.data.points[r].features[p]=d;for(var A=0,R=g.id2categories[r].length;A<R;A++)void 0===u[o=g.id2categories[r][A]]&&(a.push(o),u[o]={color:"category"!=g.settings.color.index?[]:o,radius:"category"!=g.settings.point_size.index?[]:o,points:[],id:b},b++),u[o].points.push(r),g.point2id[r]=u[o].id,"category"!=g.settings.color.index&&u[o].color.push(g.data.points[r].features[g.settings.color.index]),"category"!=g.settings.point_size.index&&u[o].radius.push(g.data.points[r].features[g.settings.point_size.index])}for(A=0,R=a.length;A<R;A++){var T=a[A];i="category"!=g.settings.color.index?g._prop2fnc.color.feature(g._get_average(u[T].color)):g._prop2settings.color.v2v[T],n="category"!=g.settings.point_size.index?g._prop2fnc.point_size.feature(g._get_average(u[T].radius)):g._prop2settings.point_size.v2v[T];var z=void 0!==g.categories[T].shape?g.categories[T].shape:"circle";g.id2points[u[T].id]=u[T].points,t=g.shape_fnc(z,u[T].id,u[T].points,l,c,n,i),g._id2object[u[T].id]=t,g.category2count[T]=g.category2count[T]+u[T].points.length,g.category2layer[T].add(t)}}}for(y=0,m=g.categories.length;y<m;y++)g.stage.add(g.category2layer[y]);g._destroy_children([g.link_layer]),g._draw_links()}g.highlight_points(g.highlighted_points),console.timeEnd("DRAW POINTS")},ChemSpace.prototype._draw_links=function(e){var t=this;if(t.settings.links.draw){var i,n,r,o,a;if(console.time("LINKS"),void 0===e)e=Object.keys(t.point2coord);for(var s=0,l=e.length;s<l;s++)if(o=e[s],void 0!==(n=t.data.points[o].links)&&n.length>0)for(var h=0,c=n.length;h<c;h++)a=n[h],r=t.point2coord[o],void 0!==t.point2coord[a]&&(r=r.concat(t.point2coord[a]),i=t.objects_ref.link.clone({points:r,point_ids:[t.point2id[o],t.point2id[a]]}),t.link_layer.add(i));t.link_layer.draw(),console.timeEnd("LINKS")}},ChemSpace.prototype._get_links_feature=function(){var e,t,i,n,r=this;console.time("LINK COUNT");for(var o={},a={},s=0,l=r.points_len;s<l;s++)if(void 0===o[e=r.point_ids[s]]&&(o[e]=0),void 0!==(i=r.data.points[e].links)&&i.length>0)for(var h=0,c=i.length;h<c;h++)void 0===o[t=i[h]]&&(o[t]=0),void 0===a[n=[e,t].sort().join("_")]&&(a[n]=!0,o[e]++,o[t]++);if(r.link_count=Object.keys(a).length,r.link_count>0){for(s=0,l=r.points_len;s<l;s++)e=r.point_ids[s],r.data.points[e].features.push(o[e]);r.data.feature_names.push("Link count")}console.timeEnd("LINK COUNT")},ChemSpace.prototype._get_point_size=function(e,t,i){return e<=t.min||null===e||void 0===e?this.settings.point_size.scale.min:e>=t.max?this.settings.point_size.scale.max:e>t.min&&e<=t.middle?this._hack_round(i.min+(e-t.min)/(t.middle-t.min)*(i.middle-i.min)):this._hack_round(i.middle+(e-t.middle)/(t.max-t.middle)*(i.max-i.middle))},ChemSpace.prototype._draw_point_size_menu=function(){var e=this;if(e.settings.navigation_toggle.point_size){var t=e.settings.point_size;if(Number.isInteger(t.index)&&"category"!==t.index){e.point_size_group=new Konva.Group;for(var i=e.objects_ref.navigation_text.clone({listening:!1,fontSize:12,y:e.header_height-15,x:e.left_margin,fontStyle:"normal"}),n=e.header_height-35,r=e.settings.width-e.right_margin,o=["max","middle","min"],a=t.scale.max,s=0,l=o.length;s<l;s++){var h=new Konva.Circle({radius:t.scale[o[s]],y:n,fill:"#D2D2D2",stroke:"#333333",strokeWidth:1,listening:!1}),c=void 0===t.params[o[s]]||"percentile"===t.value_type?e._prop2settings.point_size.values[o[s]]:t.params[o[s]];Number.isInteger(c)||(c=e._hack_round_float(c,3));var u=(i=i.clone({text:String(c),y:n-a-12-3})).width(),d=h.width(),g=u>d?u:d;h.setAttr("x",r-g/2),i.setAttr("x",r-g/2-u/2),e.point_size_group.add(h,i),r=r-g-10}var p=i.clone({text:e.data.feature_names[e.settings.point_size.index],y:e.header_height-15});p.setAttr("x",e.settings.width-e.right_margin-p.width()),r+=10;var f=new Konva.Rect({width:e.settings.width-e.right_margin-r,height:a+12+35,opacity:0,x:r,y:n-a-12-3,class:"icon",label:"Point radius",icon_name:"point_radius_icon"});e.point_size_group.add(f,p),e.navigation_layer.add(e.point_size_group)}}},ChemSpace.prototype._point_radius_click=function(t,i){var n,r,o,a=this,s=a.target_element.find(".point_radius_form"),l=a._draw_target_overlay(),h=a.settings.point_size;if(s.length)s.fadeIn();else{s=a.html_ref.menu.clone().addClass("point_radius_form").css({top:a.header_height-50,right:a.right_margin+100,width:160});a.target_element.append(s),l.click(function(){s.fadeOut(),l.fadeOut()}),s.append(a.html_ref.menu_subtitle.clone().text("Radius scale:"));var c=a._min_max_middle_inputs(h.scale,"scale").addClass("scale");s.append(c);var u=e("<div></div>").css({"margin-bottom":5});u.append(a.html_ref.menu_subtitle.clone().text("Radius by:"));var d=e("<select name='value_type'>        <option value='percentile' "+("percentile"==h.value_type?"selected":"")+">Percentiles</option>        <option value='value' "+("value"==h.value_type?"selected":"")+">Values</option>        </select>").css({padding:3,"background-color":"white"});u.append(d),s.append(u);var g=a._min_max_middle_inputs("percentile"==h.value_type?h.params:a._prop2settings.point_size.values,"params").addClass("values");s.append(g);var p=a.html_ref.redraw_button.clone();s.append(p),a._css_hover(p),s.delegate(".redraw_button","click",function(t){e(this).parents(".point_radius_form").find("input, select").each(function(){n=e(this),r=n.attr("name"),o=n.val(),datatype=n.attr("data-type"),"value_type"==r?a.settings.point_size[r]=o:""!=o&&(a.settings.point_size[datatype][r]=parseFloat(o))}),"percentile"==a.settings.point_size.value_type&&a._percentile_alert(a.settings.point_size.params),a.redraw_points(),a._update_point_radius_scale(),a.navigation_layer.draw(),l.trigger("click")})}},ChemSpace.prototype._update_point_radius_scale=function(){void 0!==this.point_size_group&&this.point_size_group.destroy(),this._draw_point_size_menu()},ChemSpace.prototype._draw_color_scale=function(){var e=this;if(e.settings.navigation_toggle.color_scale){var t=e.settings.color.params;if(Number.isInteger(e.settings.color.index)&&"category"!==e.settings.color.index){e.color_scale_group=new Konva.Group;var i=e.header_height-55,n=e.objects_ref.navigation_text.clone({fontSize:12,y:e.header_height-15,x:e.left_margin,fontStyle:"normal"}),r=n.clone({text:e.data.feature_names[e.settings.color.index]});e.color_scale_group.add(r);var o=void 0===t.min||"percentile"===e.settings.color.value_type?e._prop2settings.color.values.min:t.min,a=void 0===t.max||"percentile"===e.settings.color.value_type?e._prop2settings.color.values.max:t.max,s=void 0===t.middle||"percentile"===e.settings.color.value_type?e._prop2settings.color.values.middle:t.middle;Number.isInteger(o)||(o=e._hack_round_float(o,3),a=e._hack_round_float(a,3),s=e._hack_round_float(s,3));var l=(n=n.clone({fontSize:12})).clone({text:String(o),y:i-15}),h=n.clone({text:String(a),y:i-15}),c=n.clone({text:String(s),y:i-15}),u=l.width()+h.width()+c.width()<180?180:l.width()+h.width()+c.width()+20;h.setAttr("x",e.left_margin+u-h.width()),c.setAttr("x",e.left_margin+u/2-c.width()/2),e.color_scale_group.add(l,h,c);var d=[0,.5,1],g=[d[0],e._get_color_for_value(0,0,1,.5,e.settings.color.scale),d[1],e._get_color_for_value(.5,0,1,.5,e.settings.color.scale),d[2],e._get_color_for_value(1,0,1,.5,e.settings.color.scale)];e.color_scale=e.objects_ref.rect_gradient.clone({x:e.left_margin,y:i,width:u,fillLinearGradientColorStops:g,fillLinearGradientEndPoint:{x:u,y:80},id:e.settings.target+"_color_scale"});var p=new Konva.Rect({x:e.left_margin,y:i-15,width:u,height:70,opacity:0,label:"Color settings",class:"icon",icon_name:"color_scale_icon"});e.color_scale_group.add(e.color_scale,p),e.navigation_layer.add(e.color_scale_group)}}},ChemSpace.prototype._color_scale_click=function(t,i){var n,r,o,a=this,s=(a.settings.target,a.target_element.find(".color_scale_form")),l=a._draw_target_overlay();if(s.length)s.fadeIn();else{s=a.html_ref.menu.clone().addClass("color_scale_form").css({top:a.header_height-50,left:a.left_margin+a.color_scale.width()+10,width:160});var h=a._get_color_for_value(0,0,1,.5,a.settings.color.scale),c=a._get_color_for_value(.5,0,1,.5,a.settings.color.scale),u=a._get_color_for_value(1,0,1,.5,a.settings.color.scale),d=e("<div></div>").css({"padding-bottom":8,"border-bottom":"solid gray 1px"});d.append(e("<input type='text' class='color_scale' name='color_scale' value='"+a.settings.color.scale+"'/>").css({width:80,"margin-right":5})),d.append(e("<div class='color_button' style='background: linear-gradient(to right, "+h+","+c+","+u+")'></div>")),s.append(a.html_ref.menu_subtitle.clone().text("Color scale:"),d);var g=e("<div></div>");g.append(a.html_ref.menu_subtitle.clone().text("Color by:"));var p=e("<select name='value_type'>        <option value='percentile' "+("percentile"==a.settings.color.value_type?"selected":"")+">Percentiles</option>        <option value='value' "+("value"==a.settings.color.value_type?"selected":"")+">Values</option>        </select>").css({padding:3,"background-color":"white"});g.append(p),s.append(g),"percentile"==a.settings.color.value_type&&void 0===a.settings.color.params.max&&(a.settings.color.params={max:100,min:0,middle:50});var f=a._min_max_middle_inputs("percentile"==a.settings.color.value_type?a.settings.color.params:a._prop2settings.color.values).addClass("color_settings");s.append(f);var v=a.html_ref.redraw_button.clone();s.append(v),a._css_hover(v),a.target_element.append(s),a.target_element.find(".color_scale_form .color_button").css({border:"solid #D2D2D2 1px",height:"15px",width:"30px",display:"inline-block"}),l.click(function(){s.fadeOut(),l.fadeOut()});var _=s.find(".color_button");a._css_hover(_),_.click(function(e){a._draw_color_scales_select(this,e)}),s.delegate(".redraw_button","click",function(t){e(this).parents(".color_scale_form").find("input, select").each(function(){n=e(this),r=n.attr("name"),""!=(o=n.val())&&("value_type"==r?a.settings.color[r]=o:a.settings.color.params[r]=parseFloat(o))}),"percentile"==a.settings.color.value_type&&a._percentile_alert(a.settings.color.params),a.redraw_points(),a._update_color_scale(),a.navigation_layer.draw(),l.trigger("click")})}},ChemSpace.prototype._update_color_scale=function(){var e=this;void 0!==e.color_scale_group&&e.color_scale_group.destroy(),void 0!==e.legends_group&&e.legends_group.destroy(),e._draw_color_scale(),e._draw_legend()},ChemSpace.prototype._draw_color_scales_select=function(t,i){var n=this,r=n.target_element.find(".color_scales");if(r.length)r.fadeIn(),r.find(".color_scale");else{var o,a;r=e("<div class='color_scales'></div>");for(var s=0,l=Object.keys(n.colors),h=l.length;s<h;s++)o="<div class='color_scale' data-scale_acronym='"+(a=l[s])+"' style='background: linear-gradient(to right, "+n._get_color_for_value(0,0,1,.5,a)+","+n._get_color_for_value(.5,0,1,.5,a)+","+n._get_color_for_value(1,0,1,.5,a)+")'></div>",r.append(o);n.target_element.append(r),r.css({border:"solid #D2D2D2 2px",padding:"5px",position:"absolute",top:n.header_height-50,left:n.color_scale.width()+n.target_element.find(".color_scale_form").width()+70,"background-color":"white"});var c=n.target_element.find(".color_scale");c.css({"margin-top":3,width:80,padding:2,height:20,border:"solid #D2D2D2 1px"}),n._css_hover(c),n.target_element.find(".target_overlay").click(function(){r.fadeOut()})}c.on("click",function(){var i=e(this).attr("data-scale_acronym");e(t).prev("input:first").val(i);n.settings.color.scale=i,e(t).css({background:"linear-gradient(to right, "+n._get_color_for_value(0,0,1,.5,i)+","+n._get_color_for_value(.5,0,1,.5,i)+","+n._get_color_for_value(1,0,1,.5,i)+")"}),r.fadeOut(),c.off("click")})},ChemSpace.prototype._color_scale_mouseover=function(e,t){var i=this,n=e.getAttr("label"),r=e.getAttr("x"),o=e.getAttr("y");i.icon_tooltip=i.objects_ref.tooltip_label.clone({x:r,y:o+25}),i.icon_tooltip.add(i.objects_ref.tooltip_tag.clone()),i.icon_tooltip.add(i.objects_ref.tooltip_text.clone({text:n})),t.add(i.icon_tooltip),i.icon_tooltip.moveToTop(),e.setOpacity(.7),t.draw()},ChemSpace.prototype._color_scale_mouseout=function(e,t){this.icon_tooltip.destroy(),e.setOpacity(1),t.draw()},ChemSpace.prototype._draw_menu=function(){var t=this;t.navigation_layer=new Konva.Layer;var i=[{name:"x",label:"X axis"},{name:"y",label:"Y axis"},{name:"color",label:"Color"},{name:"point_size",label:"Point size"}],n=t.left_margin;t.settings.navigation_toggle.color_scale&&t._draw_color_scale(),t.settings.navigation_toggle.point_size&&t._draw_point_size_menu();var r=t._get_icon_group("options_icon","Options",n,20);if(t.navigation_layer.add(r),n+=40,t.settings.navigation_toggle.export_button){var o=t._get_icon_group("export_icon","Export\nin png format",n,20);t.navigation_layer.add(o),n+=40}if(t.refresh_icon=t._get_icon_group("refresh_icon","Refresh",n,20),t.navigation_layer.add(t.refresh_icon),t.refresh_icon.hide(),0==t.target_element.find(".navigation").length){var a=t.html_ref.menu.clone().addClass("navigation").css({top:10,left:60,display:"none"}),s=e("<div></div>");a.append(s),t.target_element.append(a);for(var l=0,h=i.length;l<h;l++){var c=i[l],u=t.html_ref.menu_subtitle.clone().text(c.label+":"),d=e("<select></select>").attr("data-name",c.name).css({padding:3,"background-color":"white"});"point_size"===c.name&&d.css("margin-bottom",10);for(var g=0,p=t.data.feature_names.length;g<p;g++)d.append(e("<option value='"+g+"'>"+t.data.feature_names[g]+"</option>"));"color"===c.name||"point_size"===c.name?(d.append("<option value='category'>By category</option>"),d.val(!1!==t.settings[c.name].index?t.settings[c.name].index:"category")):d.val(t.settings.coordinates[c.name]);var f=e("<div></div>").css({"margin-bottom":5});f.append(u,d),s.append(f)}get_slider_val=function(t,i){var n=e(i).attr("id")+"_value";e("#"+n).text(t)};var v=[{name:"resolution",min:1,max:50,value:t.settings.resolution,label:"Resolution",type:"resolution",step:5}];for(l=0,h=v.length;l<h;l++){var _=v[l];s.append(e("<div>          <label for="+_.name+"_slider>"+_.label+":</label>          <div id='"+t.settings.target+"_"+_.name+"_slider_value'>"+_.value+"</div>          </div>").css({display:"flex","justify-content":"space-between"})),s.append(e("<input oninput='get_slider_val(value, this)' type='range' class='slider' value="+_.value+" min="+_.min+" max="+_.max+" data-type='"+_.type+"' id='"+t.settings.target+"_"+_.name+"_slider'/>").css({width:"100%",padding:"5px 0px",margin:0}))}s.append(e("<div><input type='checkbox' name='links' checked/><div>Links</div></div>").css({display:"flex","align-items":"center","margin-top":5}));var y={links:t.link_layer};s.on("change","input[type='checkbox']",function(){var i=e(this).prop("checked"),n=e(this).attr("name"),r=1;t.settings[n].draw=i,i?e(y[n].getCanvas()._canvas).show():(r=0,e(this).attr("data-last_settings",[t.settings.coordinates.x,t.settings.coordinates.y].join("_")),e(y[n].getCanvas()._canvas).hide()),1==r&&[t.settings.coordinates.x,t.settings.coordinates.y].join("_")!=e(this).attr("data-last_settings")&&(t._destroy_children([t.link_layer]),t._draw_links()),t._sort_layers()});var m=t.html_ref.redraw_button.clone();t._css_hover(m),s.append(m),a.find("label").css({"font-weight":"bold"}),a.find("input[type='checkbox']").css({"margin-right":5}),e(".slider").on("change",function(){e(this).attr("data-type");var i=parseInt(e(this).val());t.settings.resolution=i,t._prop2settings.coordinates.x=-1}),s.on("change","select",function(){var i=e(this).attr("data-name"),n=e(this).val();if("color"===i||"point_size"===i?t.settings[i].index=isNaN(parseInt(n))?n:parseInt(n):t.settings.coordinates[i]=isNaN(parseInt(n))?n:parseInt(n),"color"===i&&"value"==t.settings.color.value_type){t.settings.color.params={};var r=t.target_element.find(".color_settings");r.find(".max").val(t._prop2settings.color.values.abs_max),r.find(".min").val(t._prop2settings.color.values.abs_min),r.find(".middle").val(t._prop2settings.color.values.middle)}}),m.on("click",function(){t.redraw_points(),t._draw_legend(),t._draw_axis_labels(),t._update_color_scale(),t._update_point_radius_scale(),t.navigation_layer.draw(),t.settings.compounds.draw&&t._draw_compounds(),t.target_element.find(".target_overlay").trigger("click")})}t.settings.navigation_toggle.axis&&t._draw_axis(),t._draw_axis_labels(),t.stage.add(t.navigation_layer)},ChemSpace.prototype._draw_axis=function(){var e=this,t=e.selection_overlay_rect.attrs.x,i=e.selection_overlay_rect.attrs.y,n=e.objects_ref.border_line.clone({points:[t,i,t+e.selection_overlay_rect.attrs.width,i]}),r=e.objects_ref.border_line.clone({points:[t+e.selection_overlay_rect.attrs.width,i,t+e.selection_overlay_rect.attrs.width,i+e.selection_overlay_rect.attrs.height]}),o=e.objects_ref.border_line.clone({points:[t,i+e.selection_overlay_rect.attrs.height,t+e.selection_overlay_rect.attrs.width,i+e.selection_overlay_rect.attrs.height]}),a=e.objects_ref.border_line.clone({points:[t,i+e.selection_overlay_rect.attrs.height,t,i]});e.navigation_layer.add(n,r,o,a)},ChemSpace.prototype._draw_axis_labels=function(){var e=this;if(0!=e.settings.navigation_toggle.axis_labels){void 0!==e.x_axis_label_group&&(e.x_axis_label_group.destroy(),e.y_axis_label_group.destroy()),e.x_axis_label_group=new Konva.Group({listening:!1}),e.y_axis_label_group=e.x_axis_label_group.clone();var t,i,n,r,o=e.settings.height-e.footer_height+5;t=e.objects_ref.navigation_text.clone({x:e.left_margin+5,y:o,text:e._hack_round_float(e.coordinate_ranges.x[0],2).toString()}),x_label=e.objects_ref.navigation_text.clone({y:o,text:e.data.feature_names[e.settings.coordinates.x].toString(),fontSize:14,fontStyle:"italic"}),x_label.setAttrs({x:e.settings.width/2-x_label.width()/2}),(i=e.objects_ref.navigation_text.clone({y:o,text:e._hack_round_float(e.coordinate_ranges.x[1],2).toString(),fontSize:14})).setAttrs({x:e.settings.width-e.right_margin-i.width()-5}),e.x_axis_label_group.add(x_label,t,i),n=e.objects_ref.navigation_text.clone({x:e.left_margin-20,y:e.settings.height-e.footer_height-10,text:e._hack_round_float(e.coordinate_ranges.y[0],2).toString(),fontSize:14,rotation:-90}),y_label=e.objects_ref.navigation_text.clone({x:e.left_margin-20,text:e.data.feature_names[e.settings.coordinates.y].toString(),fontSize:14,rotation:-90,fontStyle:"italic"}),y_label.setAttrs({y:(e.settings.height-e.footer_height-e.header_height)/2+e.header_height+y_label.width()/2}),(r=e.objects_ref.navigation_text.clone({x:e.left_margin-20,text:e._hack_round_float(e.coordinate_ranges.y[1],2).toString(),fontSize:14,rotation:-90})).setAttrs({y:e.header_height+r.width()+5}),e.y_axis_label_group.add(y_label,n,r),e.navigation_layer.add(e.x_axis_label_group,e.y_axis_label_group)}},ChemSpace.prototype._feature_switch=function(){var e=this.target_element.find(".navigation");if(e.is(":visible"))e.fadeOut();else{var t=this._draw_target_overlay();e.fadeIn(),t.click(function(){e.fadeOut(),t.fadeOut()})}},ChemSpace.prototype._draw_legend=function(){var e=this;void 0!==e.point_count&&e.point_count.destroy(),e.point_count=e.objects_ref.legend_text.clone({text:Object.keys(e.point2coord).length+" / "+e.points_len,fontSize:12,y:e.header_height-15});var t=e.left_margin+e.settings.width/2-e.point_count.getWidth()/2;if(e.point_count.setAttr("x",t),e.navigation_layer.add(e.point_count),!(e.categories.length<2)){void 0!==e.legends_group&&e.legends_group.destroy();var i,n,r=20,o=0,a=[];e.legends_group=new Konva.Group;for(var s=0,l=e.categories.length;s<l;s++){category=e.categories[s];var h=category.label+" ("+e.category2count[s]+"/"+category.points.length+")",c="category"==e.settings.color.index?category.color:e.settings.shapes.circle.fill,u=category.status?c:"white",d=void 0!==category.shape?category.shape:"circle",g=e.objects_ref.shapes[d].clone({stroke:c,fill:u,radius:6,strokeWidth:3,y:r+7,class:"category_legend"}),p=e.objects_ref.legend_text.clone({text:h,y:r,class:"category_legend"}),f=new Konva.Rect({height:22,opacity:0,y:r-4,class:"category_legend"});a.push([g,p,f]),r+=22,(i=p.width())>o&&(o=i)}for(t=e.settings.width-o-e.right_margin,s=0,l=a.length;s<l;s++)n=new Konva.Group({class:"category_legend",category_index:s}),a[s][0].setAttr("x",t-14),a[s][1].setAttr("x",t),a[s][2].setAttrs({x:t-21,width:o+21}),n.add(a[s][0],a[s][1],a[s][2]),e.legends_group.add(n);e.navigation_layer.add(e.legends_group)}},ChemSpace.prototype._process_categories=function(e){var t=this;t.category2layer={},t.categories=[];var i=0;if(!1!==t.settings.categories.order)for(var n=0,r=e.length;n<r;n++){var o=e[n],a=t.settings.categories.order.indexOf(o.label);-1!==a&&(e[n].order=a)}if(void 0!==e)for(n=0,r=(e=e.sort(function(e,t){return e.order>t.order})).length;n<r;n++)t.category2layer[n]=new Konva.Layer({category_index:n,id:t.settings.target+"_category_"+n,label:e[n].label}),void 0===e[n].color&&(e[n].color=t.settings.colors[n]),void 0===e[n].shape&&(i==t.settings.shapes.order.length&&(i=0),e[n].shape=t.settings.shapes.order[i],i++),void 0===e[n].radius&&(e[n].radius=t.settings.shapes.circle.radius),e[n].status=!0,t.categories.push(e[n]);t.categories.length>2&&(t.header_height=t.header_height+25*(t.categories.length-2))},ChemSpace.prototype._calculate_coordinates=function(t){var i,n=this;if(void 0==t&&[n._prop2settings.coordinates.x,n._prop2settings.coordinates.y].join("_")==[n.settings.coordinates.x,n.settings.coordinates.y].join("_"))return console.log("COORDINATES CACHE"),!0;if(console.time("CALCULATING COORDINATES"),n._prop2settings.coordinates=e.extend(!0,{},n.settings.coordinates),n.point2coord={},n.id2data={},void 0===t){t=n.point_ids;i=n.data.points}else{i={};for(var r=0,o=t.length;r<o;r++)i[s=t[r]]=n.data.points[s]}var a,s,l,h,c=[],u=[],d=n.settings.coordinates.x,g=n.settings.coordinates.y;if(n.settings.align_to_grid){var p=[];for(r=0,o=t.length;r<o;r++)item_data=i[t[r]].features,c.push(item_data[d]),u.push(item_data[g]),p.push([t[r],item_data[d],item_data[g]]);p.sort(n._sort_coordinates)}else for(r=0,o=t.length;r<o;r++)item_data=i[t[r]].features,c.push(item_data[d]),u.push(item_data[g]);n.coordinate_ranges={x:n._get_min_max(c),y:n._get_min_max(u)};var f=.01*(n.coordinate_ranges.x[1]-n.coordinate_ranges.x[0]),v=n.coordinate_ranges.x[1]+f,_=n.coordinate_ranges.x[0]-f,y=.01*(n.coordinate_ranges.y[1]-n.coordinate_ranges.y[0]),m=n.coordinate_ranges.y[1]+y,b=n.coordinate_ranges.y[0]-y;n.settings.compounds.draw&&(n.compound_size=n.settings.compounds.size+(1-t.length/n.points_len)*(n.settings.compounds.size-n.settings.compounds.size),n.atom_size=n.settings.compounds.atom_size+(1-t.length/n.points_len)*(n.settings.compounds.atom_size-n.settings.compounds.atom_size));var x=15+(n.settings.compounds.draw&&t.length<=n.settings.compounds.limit?n.compound_size/2:n.settings.point_size.scale.max/2),w=n._hack_round(n.left_margin+x),k=n._hack_round(n.header_height+x),S=n.settings.width-n.left_margin-n.right_margin-2*x,C=n.settings.height-n.header_height-n.footer_height-2*x,A=n._hack_round(S/parseInt(S/n.settings.resolution)),R=n._hack_round(C/parseInt(C/n.settings.resolution)),T=parseInt(A/2),z=parseInt(R/2);if(n.point_index={},n.settings.align_to_grid){var P=n._get_grid_size(S,C,p.length),L=P[0]>1?S/(P[0]-1):0,B=P[1]>1?C/(P[1]-1):0;for(k=P[1]>1?k-C:k-C/2,r=0,o=p.length;r<o;r++)w+r%P[0]*L,k+Math.floor(r/P[0])*B}else for(r=0,o=t.length;r<o;r++)l=w+(S*((a=i[s=t[r]].features)[d]-_)/(v-_)/A<<0)*A+T,h=k+C-(C*(a[g]-b)/(m-b)/R<<0)*R-z,n.point2coord[s]=[l,h],void 0===n.point_index[l]&&(n.point_index[l]={}),void 0===n.point_index[l][h]?n.point_index[l][h]=[s]:n.point_index[l][h].push(s);return console.timeEnd("CALCULATING COORDINATES"),!1},ChemSpace.prototype._get_grid_size=function(e,t,i){for(var n=e/t,r=1,o=n,a=0;a<i;)a=r*o,r++,o+=n;for(a=(o=Math.floor(o-n))*--r;a>i;)a=--o*r;return[++o,r]},ChemSpace.prototype._sort_coordinates=function(e,t){var i=e[1],n=t[1],r=e[2],o=t[2];return r==o?i<n?-1:i>n?1:0:r>o?-1:1},ChemSpace.prototype._draw_paths=function(){var e,t=this;console.time("PATHS");for(var i=0,n=t.data.paths.length;i<n;i++){for(var r=[],o=0,a=t.data.paths[i].points.length;o<a;o++){var s=t.point2coord[t.data.paths[i].points[o]];void 0!==s&&(r=r.concat(s))}var l=t.data.paths[i].color;e=t.objects_ref.path.clone({points:r,id:t.data.paths[i].label,path_index:i,stroke:void 0!==l?l:t.settings.path.stroke}),t.path_layer.add(e)}t.path_layer.draw(),console.timeEnd("PATHS")},ChemSpace.prototype._get_id2categories=function(){for(var e,t=this,i={},n=!1,r=0,o=t.points_len;r<o;r++)i[t.point_ids[r]]=[];for(r=0,o=t.categories.length;r<o;r++)for(var a=t.categories[r],s=0,l=a.points.length;s<l;s++)void 0!==i[a.points[s]]&&i[a.points[s]].push(r);for(r=0,o=t.points_len;r<o;r++)if(0==i[t.point_ids[r]].length){n=!0;break}if(n){t.category2layer[t.categories.length]=new Konva.Layer,t.categories.push({status:!0,label:"other",color:t.settings.shapes.circle.fill,radius:t.settings.shapes.circle.radius,points:[]});var h=t.categories.length-1;for(r=0,o=t.points_len;r<o;r++)0==i[e=t.point_ids[r]].length&&(t.categories[h].points.push(e),i[e].push(h))}return i},ChemSpace.prototype._icon_click=function(e){var t=this,i=e.target.attrs.icon_name;"zoom_icon"===i?t._zoom_icon_click():"options_icon"===i?t._feature_switch():"export_icon"===i?t._export_icon_click():"refresh_icon"===i?(t.refresh_icon.hide(),t.redraw_points(t.point_ids),t._draw_legend(),t._draw_axis_labels(),t.navigation_layer.draw(),t.settings.compounds.draw&&t._draw_compounds()):"color_scale_icon"===i?t._color_scale_click():"point_radius_icon"===i&&t._point_radius_click()},ChemSpace.prototype._export_icon_click=function(){var t=this,i=t.target_element.find(".export_menu"),n=t._draw_target_overlay();if(i.length)i.fadeIn();else{i=e("<div class='export_menu'><div><button type='submit' data-action='open'>Show image</button></div><div><button type='submit' data-action='save'>Save image</button></div></div>"),t.target_element.append(i),i.css({position:"absolute",top:45,left:40,"font-size":"12px",border:"solid #D2D2D2 1px",padding:"2px","background-color":"white"});var r=i.find("button");r.css({"padding-top":"7px","padding-bottom":"5px","padding-right":"8px","padding-left":"8px",color:"white",border:"solid #D2D2D2 1px",width:"100%","background-color":"#2171b5","font-weight":"bold"}),t._css_hover(r),n.click(function(){i.fadeOut(),n.fadeOut()}),r.click(function(){var i=e(this).attr("data-action");t.export_image(i)})}},ChemSpace.prototype.export_image=function(t,i){var n=this;if(void 0===t)t="save";if(void 0===i)i="chemspace";var r=n._hack_round_float(1500/n.stage.width(),1),o=n.stage.width(),a=n.stage.height(),s=e("<h3 style='margin-top: 100px; margin-left: 100px; width: "+o+"px; height: "+a+"px;'>Loading...</h3>");n.target_element.after(s),n.target_element.hide(),n.stage.width(o*r),n.stage.height(a*r),n.stage.scale({x:r,y:r}),n.stage.draw(),n.stage.toDataURL({quality:1,callback:function(r){var l;"open"===t?(l=r,window.open(l,"_blank")):e('<a download="'+i+'" href="'+r+'"></a>')[0].click(),n.stage.width(o),n.stage.height(a),n.stage.scale({x:1,y:1}),n.stage.draw(),s.remove(),n.target_element.show(),n.navigation_layer.show(),n.navigation_layer.draw(),overlay.trigger("click")}})},ChemSpace.prototype._zoom_icon_click=function(){var e=this;e.hover_layer.destroyChildren(),e.hover_layer.draw(),e.selection_rect.destroy(),e.selection_rect=!1,e.zoom_icon.destroy(),e.selection_layer.draw(),e.refresh_icon.show(),e.redraw_points(e.current_selection),e._draw_legend(),e.navigation_layer.draw(),e._draw_axis_labels(),e.navigation_layer.draw(),e.settings.compounds.draw&&e._draw_compounds()},ChemSpace.prototype._point_click=function(e){var t=e.target;this.events.point_click(t.attrs.point_ids,e)},ChemSpace.prototype._get_point_tooltip=function(t){var i,n=this,r=t.target.attrs.point_ids,o=n.point2coord[r[0]],a=(r=n.point_index[o[0]][o[1]])[0],s=n.data.points[a].label;if(1==r.length){var l=n.data.points[a].features;s=e("<div>"+(void 0===s?a:s)+"</div>")}else{l=[];for(var h=r.length,c=0;c<n.data.feature_names.length;c++){for(var u=[],d=0;d<h;d++)u.push(n.data.points[r[d]].features[c]);u.sort(n._sort_number_ascending),l.push(null!==u[0]?u[0]+" - "+u[h-1]:"-")}s=e("<div>"+(void 0===s?a:s)+"</div>")}var g=t.target.fill(),p=n.html_ref.tooltip;p.find(".point_id").html(s).css({"font-weight":"bold","border-bottom":"solid #d2d2d2 1px","padding-bottom":5,display:"flex","justify-content":"flex-start","align-items":"center"}),r.length>1&&p.find(".point_id").append(e("<div>+ "+(h-1)+"</div>").css({"border-radius":5,padding:"3px 8px","background-color":"#65aa30",color:"white","margin-left":8,"white-space":"nowrap"})),p.css({"border-color":g,"font-size":"small"});for(var f=e("<div></div>"),v=(c=0,n.data.feature_names.length);c<v;c++)(i=e("<div></div>").css({"margin-top":5})).append(e("<span>"+n.data.feature_names[c]+": </span>: ").css({color:"#333333","margin-right":5})),i.append("<span>"+(null!==l[c]?l[c]:"-")+"</span>"),f.append(i);return p.find(".dimensions").html(f),p},ChemSpace.prototype._point_mouseover=function(t){var i=this,n=i.target_element.find(".point_tooltip");n.length&&n.remove();var r=e("<div class='point_tooltip'></div>").css({position:"fixed",display:"none","z-index":100}),o=t.target.attrs.point_ids,a=i.point2coord[o[0]];o=i.point_index[a[0]][a[1]];var s=t.target.fill(),l=i.events.point_tooltip(o,s,t);r.append(l),i.target_element.append(r);var h=t.evt.clientX,c=t.evt.clientY,u=r.height(),d=a[0]>i.settings.width/2?h-r.width()-20:h+20,g=c-u/2;if(g<i.target_element[0].clientTop&&(g=i.target_element[0].clientTop),g+u>i.target_element[0].clientTop+i.settings.height&&(g=i.target_element[0].clientTop+i.settings.height-u),r.css({display:"block",top:g,left:d}),i.settings.compounds.draw&&i._draw_compound_in_tooltip(o[0]),"Circle"===t.target.className||"RegularPolygon"===t.target.className)var p=t.target.clone({listening:!1,radius:t.target.attrs.radius+3});else if("Rect"===t.target.className)p=t.target.clone({listening:!1,width:t.target.attrs.width+6,height:t.target.attrs.width+6,x:t.target.attrs.x-3,y:t.target.attrs.y-3});i.hover_layer.add(p),i.hover_layer.draw()},ChemSpace.prototype._point_mouseout=function(e){this.target_element.find(".point_tooltip").remove(),this.hover_layer.destroyChildren(),this.hover_layer.draw()},ChemSpace.prototype._path_mouseout=function(e){this.hover_layer.destroyChildren(),this.hover_layer.draw()},ChemSpace.prototype._path_mouseover=function(e){var t=this.stage.find("#"+e.target.attrs.id)[0];this.hover_layer.add(t.clone({opacity:1})),this.hover_layer.draw()},ChemSpace.prototype._path_click=function(e){var t=this.data.paths[e.target.attrs.path_index];this.events.path_click(t,e)},ChemSpace.prototype._link_mouseout=function(e){this.hover_layer.destroyChildren(),this.hover_layer.draw()},ChemSpace.prototype._link_mouseover=function(e){var t=e.target.attrs.point_ids,i=this.stage.find("#"+t[0])[0],n=this.stage.find("#"+t[1])[0];console.log(t);var r=i.clone({listening:!1,radius:i.attrs.radius+2}),o=n.clone({listening:!1,radius:n.attrs.radius+2}),a=e.target.clone({listening:!1,strokeWidth:e.target.attrs.strokeWidth+2});this.hover_layer.add(a,r,o),this.hover_layer.draw()},ChemSpace.prototype._link_click=function(e){var t=e.target.attrs.point_ids;this.events.link_click([this.id2points[t[0]],this.id2points[t[1]]],e)},ChemSpace.prototype._sort_layers=function(){var e=this;e.main_layer.moveToTop(),void 0!==e.path_layer&&e.path_layer.moveToTop(),void 0!==e.link_layer&&e.settings.links.draw&&e.link_layer.moveToTop(),"other"==e.categories[e.categories.length-1].label&&e.categories[e.categories.length-1].status&&e.category2layer[e.categories.length-1].moveToTop();for(var t=e.categories.length-1;t>=0;t--)e.categories[t].status&&"other"!=e.categories[t].label&&e.category2layer[t].moveToTop();void 0!==e.highlight_layer&&e.highlight_layer.moveToTop(),e.hover_layer.moveToTop(),e.selection_layer.moveToTop()},ChemSpace.prototype._category_legend_click=function(e){var t=this.categories[e.target.parent.getAttr("category_index")];t.status?(e.target.parent.children[0].setAttrs({fill:"white"}),t.status=!1):(e.target.parent.children[0].setAttrs({fill:e.target.parent.children[0].getAttr("stroke")}),t.status=!0),this.events.category_legend_click(t,e),this.navigation_layer.draw(),this._sort_layers()},ChemSpace.prototype._category_legend_mouseover=function(e){var t=e.target.parent.getAttr("category_index");e.target.parent.setAttr("opacity",.7),this.navigation_layer.draw(),this.main_layer.moveToTop(),this.category2layer[t].moveToTop()},ChemSpace.prototype._category_legend_mouseout=function(e){e.target.parent.setAttr("opacity",1),this.navigation_layer.draw(),this._sort_layers()},ChemSpace.prototype._icon_mouseover=function(e){var t=this,i=e.target,n=i.getAttr("label"),r=i.getAttr("x"),o=i.getAttr("y"),a=(i.getWidth(),i.getHeight()),s=t.objects_ref.tooltip_label.clone({x:r,y:o+1.2*a});s.add(t.objects_ref.tooltip_tag.clone()),s.add(t.objects_ref.tooltip_text.clone({text:n})),icon_overlay=e.target.clone({fill:"white",opacity:.2}),t.hover_layer.add(s,icon_overlay),t.hover_layer.draw()},ChemSpace.prototype._icon_mouseout=function(e){this.hover_layer.destroyChildren(),this.hover_layer.draw()},ChemSpace.prototype._get_min_max_middle=function(e,t){var i=this,n={};if(void 0==t)t={min:0,max:100,middle:50};var r=e.length-1;return e.sort(i._sort_number_ascending),n.min=t.min>0?e[i._hack_round((r-1)*t.min/100)]:Math.min.apply(null,e),n.max=t.max<100?e[i._hack_round((r-1)*t.max/100)]:Math.max.apply(null,e),n.middle=50!=t.middle?e[i._hack_round((r-1)*t.middle/100)]:e[i._hack_round((r-1)/2)],n.median=e[i._hack_round((r-1)/2)],n.abs_min=Math.min.apply(null,e),n.abs_max=Math.max.apply(null,e),n},ChemSpace.prototype._get_prop_settings=function(t){var i=this,n=i.settings[t],r=i._prop2settings[t],o="object"!=typeof r.scale?r.scale:[r.scale.min,r.scale.middle,r.scale.max,r.resolution].join("_"),a="object"!=typeof n.scale?n.scale:[n.scale.min,n.scale.middle,n.scale.max,n.resolution].join("_");if([o,r.value_type,r.index,r.params.min,r.params.middle,r.params.max].join("_")!=[a,n.value_type,n.index,n.params.min,n.params.middle,n.params.max].join("_")){var s={color:"#D2D2D2",point_size:i.settings.point_size.scale.min};console.log(t,"CALCULATION"),i._prop2settings[t]=e.extend(!0,{},n),i._prop2settings[t].resolution=i.settings.resolution;var l={};if("category"==i._prop2settings[t].index)for(var h=0,c=i.categories.length;h<c;h++)l[h]=i._prop2fnc[t].category(i.categories[h]);else{var u=i.point_ids,d=[],g=i.settings[t].index;for(h=0,c=u.length;h<c;h++){null!==(v=i.data.points[u[h]].features[g])&&void 0!==v&&(d.push(v),l[v]=null)}c=d.length;d.sort(i._sort_number_ascending);var p=i._get_min_max_middle(d,i.settings[t].params);"value"===i.settings[t].value_type&&(p.min=void 0!==n.params.min?n.params.min:p.abs_min,p.max=void 0!==n.params.max?n.params.max:p.abs_max,p.middle=void 0!==n.params.middle?n.params.middle:d[i._hack_round((c-1)/2)]),i._prop2settings[t].values=p;var f=Object.keys(l);for(h=0,c=f.length;h<c;h++){var v;l[v=f[h]]=i._prop2fnc[t].feature(parseFloat(v))}l.null=s[t]}return i._prop2settings[t].v2v=l,!1}return console.log(t,"CACHE"),!0},ChemSpace.prototype._get_min_max=function(e){var t=[];e.length;return e.sort(this._sort_number_ascending),t.push(e[0]),t.push(e[e.length-1]),t},ChemSpace.prototype._get_color_for_value=function(e,t,i,n,r){var o=this;if(null===e||void 0===e)return o.settings.shapes.circle.fill;var a=o.colors[r],s=a.start,l=a.end;if(e>i)return"rgb("+l.r+","+l.g+","+l.b+")";if(t==i||e<t)return"rgb("+s.r+","+s.g+","+s.b+")";void 0!==a.middle&&(e>=n?(t=n,s=a.middle,l=a.end):(i=n,s=a.start,l=a.middle));var h=(e-t)/(i-t);return"rgb("+o._hack_round(s.r+h*(l.r-s.r))+","+o._hack_round(s.g+h*(l.g-s.g))+","+o._hack_round(s.b+h*(l.b-s.b))+")"},ChemSpace.prototype._hack_round=function(e){return.5+e>>0},ChemSpace.prototype._hack_round_float=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},ChemSpace.prototype._sort_number_ascending=function(e,t){return e-t},ChemSpace.prototype._sort_number_descending=function(e,t){return t-e},ChemSpace.prototype.get_points_by_range=function(e){for(var t,i,n=[],r=0,o=Object.keys(this.point2coord),a=o.length;r<a;r++)t=o[r],(i=this.point2coord[t])[0]>=e.x[0]&&i[0]<=e.x[1]&&i[1]>=e.y[0]&&i[1]<=e.y[1]&&n.push(t);return n},ChemSpace.prototype._get_icon_group=function(e,t,i,n){var r=new Konva.Group({class:"icon"}),o=this.objects_ref.icon.clone({data:this.paths_ref[e],x:i,y:n,icon_name:e}),a=this.objects_ref.icon_overlay.clone({x:i,y:n,label:t,icon_name:e});return r.add(o,a),r},ChemSpace.prototype.draw_compounds=function(e,t){this.fixed_compounds=void 0!==t&&t?this.fixed_compounds.concat(e):e,this._draw_compounds()},ChemSpace.prototype.erase_compounds=function(){this.fixed_compounds=[],this._draw_compounds()},ChemSpace.prototype._draw_compounds=function(e){var t,i=this;void 0===e&&((e=Object.keys(i.point2coord)).length>i.settings.compounds.limit&&(e=0==i.fixed_compounds.length?[]:i.fixed_compounds));for(var n=0,r=Object.keys(i.point2img),o=r.length;n<o;n++)t=r[n],void 0===i.point2coord[t]||-1===e.indexOf(t)?i.point2img[t].hide():i.point2img[t].show();i._get_compound_structures(e).then(function(t){i._draw_compound_structures(e)}).catch(function(e){console.log(e)})},ChemSpace.prototype._get_compound_structures=function(t){var i=this,n=[],r=[],o={};if(void 0===t)t=Object.keys(i.point2coord);return new Promise(function(a,s){try{for(var l=0,h=t.length;l<h;l++){var c=t[l];void 0===i.data.compounds[c]?n.push(c):o[c]=i.data.compounds[c]}if(n.length>0){if(""!==i.settings.compounds.compound_url)for(l=0,h=n.length;l<h;l++){c=n[l];e.ajax({url:i.settings.compounds.compound_url,type:"GET",dataType:"json",data:{compound_id:c},success:function(e){i.data.compounds[e.compound_id]={structure:e.structure},o[e.compound_id]={structure:e.structure},r.push(e.compound_id),n.length===r.length&&a(o)}})}}else a(o)}catch(e){s(e)}})},ChemSpace.prototype._draw_compound_structures=function(t){for(var i=this,n=[],r=i.settings.compounds.size/2,o=0,a=0,s=t,l=s.length;a<l;a++)c=s[a],void 0!==i.data.compounds[c]&&void 0!==i.point2coord[c]&&(void 0===i.point2img[c]?n.push(c):(i.point2img[c].setAttrs({x:i.point2coord[c][0]-r,y:i.point2coord[c][1]-r}),i.category2layer[i.id2categories[c][0]].add(i.point2img[c]),i.point2img[c].moveToBottom(),o++));function h(){for(var e=0,t=i.categories.length;e<t;e++)i.category2layer[e].draw()}if(o<n.length)for(a=0,l=n.length;a<l;a++){var c=n[a];SmilesDrawer.parse(i.data.compounds[c].smiles,function(t){if(void 0===i.data.compounds[c].color)i.smilesDrawer.draw(t,"chemspace_img_cache","light",!1);else{var a=e.extend({},i.settings.compounds.smilesDrawer);a.color=i.data.compounds[c].color,a.width=i.settings.compounds.size,a.height=i.settings.compounds.size,current_smilesDrawer=new SmilesDrawer.Drawer(a),current_smilesDrawer.draw(t,"chemspace_img_cache","light",!1)}var s=document.getElementById("chemspace_img_cache"),l=new Image;l.key=c,l.onload=function(){var e=new Konva.Image({image:l,width:i.settings.compounds.size,height:i.settings.compounds.size,listening:!1});i.point2img[this.key]=e.clone(),i.point2img[this.key].setAttrs({x:i.point2coord[this.key][0]-r,y:i.point2coord[this.key][1]-r}),i.category2layer[i.id2categories[this.key][0]].add(i.point2img[this.key]),i.point2img[this.key].moveToBottom(),++o==n.length&&h()},l.src=s.toDataURL()},function(e){console.log(e),++o==n.length&&h()})}else h()},ChemSpace.prototype._get_compound_structure=function(e){return this.data.compounds[e]},ChemSpace.prototype._draw_compound_in_tooltip=function(e){var t=this;SmilesDrawer.parse(t.data.compounds[e].smiles,function(e){t.tooltipSmilesDrawer.draw(e,"tooltip_compound_img","light",!1)},function(e){console.log(e)})},ChemSpace.prototype._draw_target_overlay=function(){var t=this.target_element.find(".target_overlay");return t.length?t.fadeIn():((t=e("<div class='target_overlay'></div>")).css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:.5}),this.target_element.append(t)),t},ChemSpace.prototype._get_average=function(e){var t=0;if(1==e.length)var i=e[0];else{for(var n=0,r=e.length;n<r;n++)t+=e[n];i=t/e.length}return i},ChemSpace.prototype._css_hover=function(t){t.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})})},ChemSpace.prototype._percentile_alert=function(e){var t=!1;if(e.max>100||e.max<0?t="The maximum percentile must be a number between 0 and 100.":e.middle>100||e.middle<0?t="The middle percentile must be a number between 0 and 100.":(e.min>100||e.min<0)&&(t="The minimum percentile must be a number between 0 and 100."),!1!==t)return alert(t),!1},ChemSpace.prototype._min_max_middle_inputs=function(t,i){for(var n=["min","middle","max"],r=e("<div></div>").css({display:"flex","justify-content":"space-between",padding:"8px 0px","border-bottom":"solid gray 1px","margin-bottom":5}),o=0,a=n.length;o<a;o++){var s=t[n[o]],l=e("<div></div>").css({width:"30%","text-align":"center"});l.append(e("<div>"+this._capitalize(n[o])+"</div>").css({"font-size":"small",color:"gray"}));var h=e("<div></div>").css({width:"100%"});h.append(e("<input data-type='"+i+"' class='option' name='"+n[o]+"' type='text' value='"+s+"'>").css({width:"90%","text-align":"center"})),l.append(h),r.append(l)}return r},ChemSpace.prototype._capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},ChemSpace.prototype._shuffle=function(e){var t=[];for(console.time("SHUFFLE");e.length;){var i=Math.floor(Math.random()*e.length),n=e.splice(i,1);t.push(n[0])}return console.timeEnd("SHUFFLE"),t}}(jQuery);